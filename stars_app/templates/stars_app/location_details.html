{% extends 'stars_app/base.html' %}
{% load static %}
{% load markdown_extras %}
{% load custom_filters %}
{% block body_class %}location-details-page{% endblock %}


<!-- Extra header content -->
{% block extra_head %}
<link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
<link href="{% static 'css/components/photo-gallery.css' %}" rel="stylesheet">

<style>
/* Hero Section Styles */
.hero-section {
    margin: calc(-1 * var(--space-lg));
    margin-bottom: var(--space-xl);
}

.hero-carousel {
    position: relative;
    height: 500px;
    overflow: hidden;
    border-radius: var(--radius-md);
}

.carousel-container {
    position: relative;
    width: 100%;
    height: 100%;
}

.carousel-content {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
}

.carousel-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
}

.carousel-slide.active {
    opacity: 1;
}

.carousel-slide img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.carousel-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: var(--text-primary);
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: var(--font-size-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    z-index: 2;
}

.carousel-nav:hover {
    background: rgba(0, 0, 0, 0.9);
    transform: translateY(-50%) scale(1.1);
}

.carousel-nav.prev {
    left: var(--space-md);
}

.carousel-nav.next {
    right: var(--space-md);
}

.hero-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.7) 100%);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    z-index: 1;
}

.hero-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: var(--space-lg);
}

.hero-title-section h1 {
    color: var(--text-primary);
    font-size: var(--font-size-3xl);
    margin: 0 0 var(--space-sm) 0;
    text-shadow: var(--text-shadow);
}

.hero-rating {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-sm);
}

.hero-rating .rating-display {
    display: flex;
    gap: var(--space-xs);
}

.hero-rating .rating-display i {
    color: var(--text-tertiary);
    font-size: var(--font-size-base);
    text-shadow: var(--text-shadow);
}

.hero-rating .rating-display i.filled {
    color: var(--golden);
}

.hero-rating .rating-count {
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    text-shadow: var(--text-shadow);
}

.hero-actions {
    display: flex;
    gap: var(--space-sm);
    align-items: flex-start;
}

.hero-action-btn {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: rgba(45, 45, 45, 0.9);
    color: var(--text-primary);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all var(--transition-base);
    text-decoration: none;
    backdrop-filter: blur(10px);
}

.hero-action-btn:hover {
    background: rgba(45, 45, 45, 1);
    border-color: var(--primary);
    transform: translateY(-2px);
}

.hero-action-btn.favorite-button.favorited {
    background: rgba(255, 105, 180, 0.9);
    border-color: var(--pink);
}

.photo-credit {
    padding: var(--space-md) var(--space-lg);
    color: var(--text-secondary);
    font-size: var(--font-size-xs);
    text-shadow: var(--text-shadow);
}

/* Photos Section */
.photos-section {
    margin-bottom: var(--space-xl);
}

.photos-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
}

.photos-header h2 {
    color: var(--text-primary);
    margin: 0;
}

.photos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-md);
}

.photo-thumbnail {
    aspect-ratio: 4/3;
    border-radius: var(--radius-sm);
    overflow: hidden;
    cursor: pointer;
    transition: transform var(--transition-base);
}

.photo-thumbnail:hover {
    transform: scale(1.05);
}

.photo-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.photo-thumbnail.primary {
    border: 2px solid var(--primary);
}

/* About Section */
.about-section {
    margin-bottom: var(--space-xl);
}

.about-section h2 {
    color: var(--text-primary);
    margin-bottom: var(--space-md);
}

.location-description {
    color: var(--text-secondary);
    font-size: var(--font-size-base);
    line-height: 1.6;
    margin: 0;
}

/* Location Details Page Styling */
.location-details-page {
    background-color: var(--background-dark);
    min-height: 100vh;
}

.location-details-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-lg);
}

/* Reviews Section */
.reviews-section {
    margin-bottom: var(--space-xl);
}

/* Review Form */
.review-form-container {
    background: var(--surface);
    padding: var(--space-lg);
    border-radius: var(--radius-xs);
    margin-bottom: var(--space-xl);
}

.review-form-container h5 {
    color: var(--text-primary);
    margin-bottom: var(--space-lg);
    font-size: var(--font-size-lg);
}

.review-form {
    display: grid;
    gap: var(--space-md);
}

.rating-input {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.rating-input label {
    color: var(--text-primary);
    font-weight: normal;
}

.star-rating {
    display: block;
    gap: var(--space-xs);
}

.star-rating input {
    display: none;
}

.star-rating {
    display: flex;
    gap: var(--space-xs);
}

.star-rating label {
    cursor: pointer;
    position: relative;
}

.star-rating label svg {
    width: 24px;
    height: 24px;
    color: var(--background-dark);
    fill: var(--background-dark);
    transition: all var(--transition-base);
}

.star-rating label.filled svg {
    color: var(--golden);
    fill: var(--golden);
}

.star-rating label.hover svg {
    color: var(--golden);
    fill: var(--golden);
}

/* Review Form Comment Input */
.review-comment-input {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.review-comment-input label {
    color: var(--text-primary);
    font-weight: lighter;
}

.review-comment-input textarea {
    width: 100%;
    background: var(--background-dark);
    border: 0px;
    border-radius: var(--radius-xs);
    padding: var(--space-sm);
    color: var(--text-primary);
    resize: vertical;
    font-family: inherit;
    line-height: 1.5;
    box-sizing: border-box;
}

.review-comment-input textarea:focus {
    outline: none;
    border: 0.5px solid var(--primary);
}

.review-comment-input textarea::placeholder {
    color: var(--text-tertiary);
}

.submit-review {
    padding: var(--space-sm);
    background-color: var(--primary);
    border: none;
    border-radius: var(--radius-md);
    color: var(--text-primary);
    cursor: pointer;
    transition: background-color var(--transition-base);
    justify-self: start;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.submit-review:hover {
    background-color: var(--primary-light);
}

/* Submit review button when in toolbar */
.comment-toolbar .submit-review {
    padding: var(--space-sm) var(--space-md);
    justify-self: auto;
}

/* Login Prompt styling */
.login-prompt-container {
    background: var(--background-dark);
    border-radius: var(--radius-sm);
    padding: var(--space-lg);
    text-align: center;
    margin-bottom: var(--space-xl);
}

.login-prompt-message {
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
    font-size: var(--font-size-sm);
}

.login-prompt-button {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--primary);
    color: var(--text-primary);
    text-decoration: none;
    border-radius: var(--radius-sm);
    transition: background-color var(--transition-base);
}

.login-prompt-button:hover {
    background: var(--primary-light);
}

.login-prompt-button i {
    font-size: var(--font-size-sm);
}

/* Owner message styling */
.owner-message-container {
    background: var(--background-dark);
    border-radius: var(--radius-sm);
    padding: var(--space-lg);
    text-align: center;
    margin-bottom: var(--space-xl);
    border: 1px solid var(--text-tertiary);
}

.owner-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-md);
}

.owner-message p {
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    max-width: 400px;
    margin: 0 auto;
}

.owner-message i {
    font-size: var(--font-size-xl);
    color: var(--negate-light);
}

/* Review Cards */
.reviews-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
}

.review-card {
    background: var(--surface);
    padding: var(--space-lg);
    border-radius: var(--radius-xs);
    border: none;
}

.rating-display {
    display: flex;
    flex-direction: row;
    gap: var(--space-xs);
}

.rating-display svg {
    color: var(--text-tertiary);
    fill: none; /* Consistent outline style for empty stars */
    width: 16px;
    height: 16px;
}

.rating-display svg.filled {
    color: var(--golden);
    fill: var(--golden);
}

.review-date {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

.review-author-section {
    display: flex;
    gap: var(--space-md);
}

.review-rating-section {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: var(--space-sm);
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}

.review-profile-picture {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-xs);
    object-fit: cover;
    background-color: var(--background);
    border: 1px solid var(--background-dark);
}

.review-author {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}

.review-username {
    color: var(--text-primary);
    font-weight: bold;
}

.review-comment {
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-md);
}

.no-reviews {
    text-align: center;
    color: var(--text-tertiary);
    padding: var(--space-xl);
}

/* Delete button */
.review-meta {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    justify-content: flex-end;
}

.delete-review-btn {
    background: none;
    border: none;
    padding: var(--space-xs);
    color: var(--text-tertiary);
    cursor: pointer;
    transition: color var(--transition-base);
}

.delete-review-btn:hover {
    color: var(--negate-light);
}

.current-user-review {
    border: 0.5px solid var(--primary-light);
    background: var(--surface);
}

.your-review-badge {
    font-size: var(--font-size-xs);
    color: var(--primary-light);
    
}

.review-comments-section {
    margin-top: var(--space-md);
    border-top: 1px solid var(--text-tertiary);
}

.comments-toggle.inline {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs);
    font-size: var(--font-size-sm);
    transition: color var(--transition-base);
}

.comments-toggle.inline:hover {
    color: var(--text-primary);
}
.comments-toggle.inline:hover .comments-count {
    color: var(--text-primary);
}

/* Ensure SVG icon inherits color and transitions smoothly */
.comments-toggle.inline svg {
    transition: stroke var(--transition-base);
}
.comments-toggle.inline .comments-count {
    transition: color var(--transition-base);
}

/* Comments section styling */
.comments-container {
    margin-top: var(--space-md);
}

.comment-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    margin-bottom: var(--space-xl);
}

.comment-input {
    width: 100%;
    background: var(--background-dark);
    border: 0px;
    border-radius: var(--radius-xs);
    padding: var(--space-sm);
    color: var(--text-primary);
    font-family: inherit;
    line-height: 1.5;
    box-sizing: border-box;
    min-height: 60px;
    max-height: 200px;
    overflow-y: auto;
    font-size: var(--font-size-xs);
}

.comment-input:focus {
    outline: none;
    border: 0.5px solid var(--primary);
}

.comment-input:empty:before {
    content: attr(data-placeholder);
    color: var(--text-tertiary);
    pointer-events: none;
}

/* Styling for formatted content in contenteditable */
.comment-input strong {
    font-weight: bold;
}

.comment-input em {
    font-style: italic;
}

.comment-input u {
    text-decoration: underline;
}

.comment-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-sm);
}

.comment-formatting-tools {
    display: flex;
    gap: var(--space-xs);
}

.formatting-btn {
    background: var(--background-dark);
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: var(--space-xs);
    border-radius: var(--radius-md);
    transition: all var(--transition-base);
    font-weight: bold;
    font-size: var(--font-size-sm);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.formatting-btn:hover {
    background: var(--background);
    color: var(--text-primary);
}

.formatting-btn.active {
    background: var(--primary);
    color: var(--text-primary);
}

.formatting-btn.active:hover {
    background: var(--primary-light);
}

.submit-comment {
    padding: var(--space-sm) var(--space-md);
    background-color: var(--primary);
    border: none;
    border-radius: var(--radius-md);
    color: var(--text-primary);
    cursor: pointer;
    transition: background-color var(--transition-base);
}

.submit-comment:hover {
    background-color: var(--primary-light);
}

/* Disabled comment form styles */
.comment-form.disabled {
    opacity: 0.7;
}

.comment-form.disabled .comment-input {
    background: var(--background-dark);
    color: var(--text-tertiary);
    cursor: not-allowed;
}

.comment-form.disabled .formatting-btn {
    background: var(--background-dark);
    color: var(--text-tertiary);
    cursor: not-allowed;
    opacity: 0.6;
}

.comment-form.disabled .formatting-btn:hover {
    background: var(--background-dark);
    color: var(--text-tertiary);
}

.comment-form.disabled .submit-comment {
    background: var(--background-dark);
    color: var(--text-tertiary);
    cursor: not-allowed;
}

.comment-form.disabled .submit-comment:hover {
    background: var(--background-dark);
    color: var(--text-tertiary);
}

.login-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--primary);
    color: var(--text-primary);
    text-decoration: none;
    border-radius: var(--radius-sm);
    transition: background-color var(--transition-base);
}

.login-link:hover {
    background: var(--primary-light);
}

.login-link i {
    font-size: var(--font-size-sm);
}

.comment {
    display: flex;
    gap: var(--space-md);
    padding: 0 0 var(--space-md) 0;
}

.comment-profile-picture {
    width: 24px;
    height: 24px;
    border-radius: var(--radius-xs);
    object-fit: cover;
    border: 1px solid var(--background-dark);
}

.comment-content {
    flex: 1;
}

.comment-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.comment-username {
    font-weight: bold;
    font-size: var(--font-size-sm);
    color: var(--text-primary);
}

.comment-date {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

.comment-text {
    color: var(--text-primary);
    font-size: var(--font-size-xs);
}

.comment-login-prompt {
    background: var(--background);
    border-radius: var(--radius-sm);
    padding: var(--space-md);
    text-align: center;
    margin-bottom: var(--space-md);
}

.comment-login-prompt p {
    color: var(--text-secondary);
    margin-bottom: var(--space-sm);
    font-size: var(--font-size-sm);
}

/* Voting system styles */
.vote-controls {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
}

.vote-button {
    background: none;
    border: none;
    padding: var(--space-xs);
    cursor: pointer;
    color: var(--text-tertiary);
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    
}

.vote-button:hover {
    color: var(--text-primary);
}

.vote-button.voted.upvote {
    color: var(--primary-light);
}
.vote-button.voted.downvote {
    color: var(--negate-light);
}

.vote-button.voted:hover {
    opacity: 0.8;
    color: var(--primary);
}

.vote-button.voted.downvote:hover {
    opacity: 0.8;
    color: var(--negate);
}

.upvote-count, .downvote-count, .comments-count {
    color: var(--text-secondary);
    font-size: var(--font-size-xs);
    min-width: 2em;
    text-align: left;
    display: inline-block;
}

.vote-button.disabled {
    opacity: 0.3;
    cursor: not-allowed;
    pointer-events: none;
    color: var(--text-tertiary);
}

.vote-button.disabled:hover {
    color: var(--text-tertiary);
    transform: none;
}

/* Pagination styling */
.pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: var(--space-xl);
    gap: var(--space-sm);
}

.pagination-button {
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--text-tertiary);
    border-radius: var(--radius-sm);
    background: var(--surface);
    color: var(--text-primary);
    cursor: pointer;
    transition: all var(--transition-base);
}

.pagination-button:hover:not(.disabled) {
    background: var(--primary);
    border-color: var(--primary);
}

.pagination-button.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-info {
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
}

.current-page {
    padding: var(--space-sm) var(--space-md);
    background: var(--primary);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
}

/* Astronomy Data Section */
.astronomy-data-section {
    margin-bottom: var(--space-xl);
}

.astronomy-data-section h2 {
    color: var(--text-primary);
    margin-bottom: var(--space-lg);
}

.data-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: var(--space-lg);
}

.data-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    padding: var(--space-lg);
    background: var(--surface);
    border-radius: var(--radius-sm);
    border: 1px solid var(--text-tertiary);
}

.data-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary);
    color: var(--text-primary);
    font-size: var(--font-size-lg);
    flex-shrink: 0;
}

.data-icon.elevation {
    background: var(--event-aurora);
}

.data-icon.cloud {
    background: var(--text-tertiary);
}

.data-icon.light {
    background: var(--golden);
}

.data-icon.calendar {
    background: var(--event-comet);
}

.data-icon.access {
    background: var(--negate-light);
}

.data-content h3 {
    color: var(--text-primary);
    font-size: var(--font-size-base);
    margin: 0 0 var(--space-xs) 0;
}

.data-content p {
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    margin: 0;
    line-height: 1.4;
}

/* Photo Upload Modal Styles */
.photo-upload-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.photo-upload-modal .modal-content {
    background: var(--surface);
    border-radius: var(--radius-md);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid var(--text-tertiary);
}

.photo-upload-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-lg);
    border-bottom: 1px solid var(--text-tertiary);
}

.photo-upload-modal .modal-header h3 {
    margin: 0;
    color: var(--text-primary);
}

.photo-upload-modal .modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: var(--font-size-xl);
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.photo-upload-modal .modal-close:hover {
    color: var(--text-primary);
}

.photo-upload-modal .photo-upload-form {
    padding: var(--space-lg);
}

.photo-upload-modal .form-group {
    margin-bottom: var(--space-md);
}

.photo-upload-modal .form-group label {
    display: block;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
    font-weight: 500;
}

.photo-upload-modal input[type="file"] {
    width: 100%;
    padding: var(--space-sm);
    background: var(--background-dark);
    border: 1px solid var(--text-tertiary);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    cursor: pointer;
}

.photo-upload-modal textarea {
    width: 100%;
    background: var(--background-dark);
    border: 1px solid var(--text-tertiary);
    border-radius: var(--radius-sm);
    padding: var(--space-sm);
    color: var(--text-primary);
    resize: vertical;
    font-family: inherit;
}

.photo-upload-modal .form-actions {
    display: flex;
    gap: var(--space-md);
    justify-content: flex-end;
    margin-top: var(--space-lg);
}

.photo-upload-modal .btn-cancel,
.photo-upload-modal .btn-primary {
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    border: none;
}

.photo-upload-modal .btn-cancel {
    background: var(--background-dark);
    border: 1px solid var(--text-tertiary);
    color: var(--text-primary);
}

.photo-upload-modal .btn-cancel:hover {
    background: var(--surface);
}

.photo-upload-modal .btn-primary {
    background: var(--primary);
    color: var(--text-primary);
}

.photo-upload-modal .btn-primary:hover {
    background: var(--primary-light);
}

.photo-upload-modal .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Verification Badge */
.verification-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--success);
    color: var(--text-primary);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    margin-left: var(--space-sm);
}

.verification-badge i {
    font-size: var(--font-size-sm);
}

/* Category and Tags */
.location-meta-info {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-md);
    align-items: center;
    margin-top: var(--space-sm);
}

.category-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--surface);
    border: 1px solid var(--text-tertiary);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: var(--font-size-sm);
}

.category-badge i {
    color: var(--primary);
}

.tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
}

.tag-chip {
    padding: var(--space-xs) var(--space-sm);
    background: var(--background-dark);
    border: 1px solid var(--text-tertiary);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-size: var(--font-size-xs);
    text-decoration: none;
    transition: all var(--transition-base);
}

.tag-chip:hover {
    background: var(--primary);
    border-color: var(--primary);
    color: var(--text-primary);
}

/* Visitor Info */
.visitor-info {
    display: flex;
    gap: var(--space-lg);
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
}

.visitor-info-item {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
}

/* Report Button */
.report-button {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all var(--transition-base);
    border: 1px solid var(--negate);
    background: var(--surface);
    color: var(--negate);
}

.report-button:hover {
    background: var(--negate);
    color: var(--text-primary);
}

/* Report Modal */
.report-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.report-modal-content {
    background: var(--surface);
    border-radius: var(--radius-md);
    max-width: 500px;
    width: 90%;
    padding: var(--space-lg);
}

.report-form .form-group {
    margin-bottom: var(--space-md);
}

.report-form label {
    display: block;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
}

.report-form select,
.report-form textarea {
    width: 100%;
    background: var(--background-dark);
    border: 1px solid var(--text-tertiary);
    border-radius: var(--radius-sm);
    padding: var(--space-sm);
    color: var(--text-primary);
}

/* Responsive Design */
@media (max-width: 768px) {
    .carousel-nav {
        width: 40px;
        height: 40px;
        font-size: var(--font-size-base);
    }

    .photos-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }

    .data-grid {
        grid-template-columns: 1fr;
    }

    .data-item {
        padding: var(--space-md);
    }
}

/* Reviews header with toggle button */
.reviews-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
}

.toggle-review-form {
    background: var(--surface);
    border: none;
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-md);
    cursor: pointer;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    transition: all var(--transition-base);
    font-size: var(--font-size-sm);
}

.toggle-review-form:hover {
    color: var(--text-primary);
    background: var(--surface-light);
}

.toggle-review-form.active {
    background: var(--primary);
    color: var(--white);
}

.toggle-review-form.active:hover {
    background: var(--primary-light);
}

.toggle-review-form svg {
    width: 16px;
    height: 16px;
}

.toggle-review-form.disabled {
    background: var(--background-dark);
    color: var(--text-tertiary);
    cursor: not-allowed;
    opacity: 0.7;
}

.toggle-review-form.disabled:hover {
    background: var(--background-dark);
    color: var(--text-tertiary);
}

.review-form-container {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Review Metrics Card */
.review-metrics-card {
    border: 1px solid var(--surface);
    border-radius: var(--radius-xs);
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
}

.metrics-header {
    display: flex;
    gap: var(--space-xl);
    align-items: flex-start;
}

.overall-rating {
    text-align: center;
    min-width: 120px;
    border-right: 0.5px solid var(--text-tertiary);
}

.rating-number {
    font-size: var(--font-size-3xl);
    font-weight: bold;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.rating-stars {
    display: flex;
    justify-content: center;
    gap: var(--space-xs);
    margin-bottom: var(--space-xs);
}

.rating-stars svg {
    width: 16px;
    height: 16px;
    color: var(--text-tertiary); /* Default to empty state */
    fill: none; /* Default to outline style */
}

.total-reviews {
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
}

.rating-info {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.rating-breakdown {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 117px; /* Match the overall-rating height */
}

.rating-row {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex: 1;
    max-height: 20px; /* Ensure consistent row height */
}

.rating-bar {
    flex: 1;
    height: 8px;
    background: var(--surface);
    border-radius: 4px;
    overflow: hidden;
}

.rating-bar-fill {
    height: 100%;
    background: var(--golden);
    transition: width var(--transition-base);
}

.star-label {
    color: var(--text-primary);
    font-size: var(--font-size-xs);
    min-width: 3em;
    text-align: left;
}

.rating-count {
    color: var(--text-tertiary);
    font-size: var(--font-size-xs);
    min-width: 6em;
    text-align: left;
}

@media (max-width: 768px) {
    .metrics-header {
        flex-direction: column;
        gap: var(--space-md);
        align-items: stretch;
    }
    
    .overall-rating {
        width: 100%;
        border-right: none;
        padding-right: 0;
        display: flex;
        align-items: center;
        gap: var(--space-md);
        text-align: left;
        min-width: auto;
    }
    
    .rating-number {
        margin-bottom: 0;
        line-height: 1;
        flex-shrink: 0;
    }
    
    .rating-stars {
        margin-bottom: 0;
    }

    .total-reviews {
        margin: 0;
    }
    
    .rating-info {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-start;
        flex: 1;
        gap: 2px;
    }
    
    .rating-breakdown {
        height: auto;
        justify-content: flex-start;
        gap: var(--space-sm);
    }
    
    .rating-row {
        margin-bottom: 0;
        max-height: none;
        flex: none;
        gap: var(--space-md);
    }
    
    .rating-bar {
        flex: 2;
        min-width: 120px;
    }
    
    .star-label {
        min-width: 2.5em;
    }
    
    .rating-count {
        min-width: 5em;
        text-align: left;
    }
}

/* Ellipsis menu styles */
.ellipsis-menu-wrapper {
    position: relative;
    display: inline-block;
}

.ellipsis-menu-button {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: var(--space-xs);
    margin-left: var(--space-xs);
    border-radius: var(--radius-sm);
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    justify-content: center;
}

.ellipsis-menu-button:hover {
    color: var(--text-primary);
    background: var(--surface-light);
}

.ellipsis-menu-button svg {
    width: 16px;
    height: 16px;
}

/* Dropdown menu styles */
.dropdown-menu {
    position: absolute;
    left: 100%;
    bottom: 0;
    margin-left: var(--space-sm);
    background: var(--background-dark);
    border-radius: var(--radius-sm);
    min-width: 100px;
    z-index: 1000;
    overflow: hidden;
    display: flex;
    flex-direction: column-reverse;
    padding-top: var(--space-xs);
    padding-bottom: var(--space-xs);
}

.dropdown-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    width: 100%;
    padding: var(--space-sm) var(--space-sm);
    background: none;
    border: none;
    color: var(--text-primary);
    cursor: pointer;
    transition: background-color var(--transition-base);
    text-align: left;
    font-size: var(--font-size-xs);
}

.dropdown-item:hover {
    background: var(--surface-light);
}

.dropdown-item.edit-item {
    color: var(--text-primary);
}

.dropdown-item.edit-item:hover {
    background: var(--surface-light);
    color: var(--text-primary);
}

.dropdown-item.delete-item {
    color: var(--text-primary);
}

.dropdown-item.delete-item:hover {
    background: var(--surface-light);
    color: var(--text-primary);
}

.dropdown-item.report-item {
    color: var(--text-primary);
}

.dropdown-item.report-item:hover {
    background: var(--surface-light);
    color: var(--text-primary);
}

.dropdown-item i,
.dropdown-item svg {
    font-size: var(--font-size-sm);
    width: 16px;
    height: 16px;
    text-align: center;
    flex-shrink: 0;
}

.dropdown-item span {
    flex: 1;
}

/* Universal Edit Mode Styles */
.edit-mode {
    display: none !important;
}

.edit-controls {
    margin-top: var(--space-sm);
}

.edit-actions {
    display: flex;
    gap: var(--space-sm);
}

.save-edit, .cancel-edit {
    padding: var(--space-sm) var(--space-md);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: background-color var(--transition-base);
    font-size: var(--font-size-xs);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
}

.save-edit {
    background-color: var(--primary);
    color: var(--text-primary);
}

.save-edit:hover {
    background-color: var(--primary-light);
}

.cancel-edit {
    background-color: var(--background-dark);
    color: var(--text-secondary);
}

.cancel-edit:hover {
    background-color: var(--surface-light);
    color: var(--text-primary);
}

/* Comment edit button */
.comment-edit-btn {
    background: none;
    border: none;
    color: var(--text-tertiary);
    cursor: pointer;
    padding: var(--space-xs);
    border-radius: var(--radius-sm);
    transition: all var(--transition-base);
    margin-left: var(--space-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity var(--transition-base);
}

.comment:hover .comment-edit-btn {
    opacity: 1;
}

.comment-edit-btn:hover {
    color: var(--text-primary);
    background: var(--surface-light);
}

.comment-edit-btn svg {
    width: 14px;
    height: 14px;
}
</style>
{% endblock %}


{% block content %}
<div class="location-details-page">
    {% csrf_token %}

    <div class="location-details-container">
        <!-- Hero Section with Image Carousel -->
        <div class="hero-section">
            <div class="hero-carousel" id="heroCarousel">
                <div class="carousel-container">
                    <button class="carousel-nav prev" id="carouselPrev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="carousel-content" id="carouselContent">
                        <!-- Photos will be loaded here -->
                    </div>
                    <button class="carousel-nav next" id="carouselNext">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="hero-overlay">
                    <div class="hero-header">
                        <div class="hero-title-section">
                            <h1>{{ location.name }}</h1>
                            {% if location.is_verified %}
                                <span class="verification-badge" title="Verified on {{ location.verification_date|date:'M d, Y' }}">
                                    <i class="fas fa-check-circle"></i>
                                    Verified
                                </span>
                            {% endif %}
                            <div class="hero-rating">
                                <div class="rating-display">
                                    {% for i in "12345"|make_list %}
                                        {% if forloop.counter <= average_rating %}
                                            {% include 'stars_app/icons/star-filled-icon.svg' %}
                                        {% else %}
                                            {% include 'stars_app/icons/star-empty-icon.svg' %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <span class="rating-count">{{ total_reviews }} review{{ total_reviews|pluralize }}</span>
                            </div>
                        </div>
                        <div class="hero-actions">
                            {% if user.is_authenticated %}
                                <button class="hero-action-btn favorite-button" type="button" id="favoriteButton">
                                    <i class="fas fa-heart"></i>
                                    <span id="favoriteText">Favorite</span>
                                </button>
                                
                                {% if not is_owner %}
                                    <button class="hero-action-btn report-button" type="button" id="reportButton">
                                        <i class="fas fa-flag"></i>
                                        Report
                                    </button>
                                {% endif %}
                            {% endif %}
                            <a href="{% url 'map' %}?lat={{ location.latitude }}&lng={{ location.longitude }}&zoom=12"
                               class="hero-action-btn view-map-button">
                                <i class="fas fa-map"></i>
                                View on Map
                            </a>
                        </div>
                    </div>
                    <div class="photo-credit" id="photoCredit">
                        <!-- Photo credit will be shown here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Photo Gallery Section -->
        <div class="photos-section">
            <div class="photos-header">
                <h2 id="photosTitle">Photos (0)</h2>
                {% if user.is_authenticated %}
                    <button class="btn-upload-photo" id="openUploadModal">
                        <i class="fas fa-upload"></i>
                        Upload Photo
                    </button>
                {% endif %}
            </div>
            <div class="photos-grid" id="photosGrid">
                <!-- Photos will be loaded here -->
            </div>
        </div>

        <!-- About Section -->
        <div class="about-section">
            <h2>About this Location</h2>
            <p class="location-description">
                {% if location.description %}
                    {{ location.description }}
                {% else %}
                    This astronomical viewing location offers exceptional stargazing conditions. Perfect for observing deep sky objects, the Milky Way, and celestial events.
                {% endif %}
            </p>
        </div>

        <!-- Astronomy Data Section -->
        <div class="astronomy-data-section">
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="data-content">
                        <h3>Coordinates</h3>
                        <p>{{ location.latitude|floatformat:4 }}, {{ location.longitude|floatformat:4 }}</p>
                    </div>
                </div>
                <div class="data-item">
                    <div class="data-icon elevation">
                        <i class="fas fa-mountain"></i>
                    </div>
                    <div class="data-content">
                        <h3>Elevation</h3>
                        <p>{{ location.elevation|floatformat:0 }} meters</p>
                    </div>
                </div>
                <div class="data-item">
                    <div class="data-icon cloud">
                        <i class="fas fa-cloud"></i>
                    </div>
                    <div class="data-content">
                        <h3>Current Cloud Cover</h3>
                        <p>{{ location.cloudCoverPercentage|default:"Unknown"|floatformat:0 }}%</p>
                    </div>
                </div>
                <div class="data-item">
                    <div class="data-icon light">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="data-content">
                        <h3>Light Pollution</h3>
                        <p>{% if location.light_pollution_value < 18 %}Minimal{% elif location.light_pollution_value < 20 %}Low{% elif location.light_pollution_value < 21 %}Moderate{% else %}High{% endif %}</p>
                    </div>
                </div>
                <div class="data-item">
                    <div class="data-icon calendar">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="data-content">
                        <h3>Best Viewing Months</h3>
                        <p>{% if location.administrative_area == "Hawaii" %}Year-round optimal{% elif location.country == "United States" %}April - September{% else %}Check local conditions{% endif %}</p>
                    </div>
                </div>
                <div class="data-item">
                    <div class="data-icon access">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="data-content">
                        <h3>Access Information</h3>
                        <p>{% if location.verification_notes %}{{ location.verification_notes }}{% else %}Check local conditions and accessibility before visiting. {% if location.is_verified %}This location has been verified.{% endif %}{% endif %}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="reviews-section">
            <div class="reviews-header">
                <h2>Reviews</h2>
                <!-- Show toggle button for all users with appropriate state -->
                {% if not user.is_authenticated %}
                    <button class="toggle-review-form disabled" id="toggleReviewForm" disabled>
                        <span>Login to Review</span>
                        {% include 'stars_app/icons/lock-icon.svg' %}
                    </button>
                {% elif user.is_authenticated and user_has_reviewed %}
                    <button class="toggle-review-form disabled" id="toggleReviewForm" disabled>
                        <span>Already Reviewed</span>
                        {% include 'stars_app/icons/lock-icon.svg' %}
                    </button>
                {% elif is_owner %}
                    <button class="toggle-review-form disabled" id="toggleReviewForm" disabled>
                        <span>You own this location</span>
                        {% include 'stars_app/icons/lock-icon.svg' %}
                    </button>
                {% else %}
                    <button class="toggle-review-form" id="toggleReviewForm">
                        <span>Write a Review</span>
                        {% include 'stars_app/icons/square-pen-icon.svg' %}
                    </button>
                {% endif %}
            </div>

            <!-- Review form container - only shows for authenticated users who can review -->
            <div class="review-form-container" id="reviewFormContainer" style="display: none;">
                {% if user.is_authenticated and not user_has_reviewed and not is_owner %}
                    <!-- Review form for authenticated users who haven't reviewed -->
                    <h5>Write a Review</h5>
                    <form method="POST" class="review-form">
                        {% csrf_token %}
                        <div class="rating-input">
                            <label>Rating:</label>
                            <div class="star-rating">
                                {% for i in "12345" %}
                                <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required>
                                <label for="star{{ i }}">
                                    {% include 'stars_app/icons/star-filled-icon.svg' %}
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="review-comment-input">
                            <label for="comment">Comment:</label>
                            <div class="comment-form">
                                <div class="comment-input" 
                                     contenteditable="true"
                                     data-placeholder="Share your experience at this location..." 
                                     data-name="comment"></div>
                                <input type="hidden" name="comment" class="hidden-content">
                                <div class="comment-toolbar">
                                    <div class="comment-formatting-tools">
                                        <button type="button" class="formatting-btn" title="Bold">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bold-icon lucide-bold"><path d="M6 12h9a4 4 0 0 1 0 8H7a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h7a4 4 0 0 1 0 8"/></svg>
                                        </button>
                                        <button type="button" class="formatting-btn" title="Italic">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-italic-icon lucide-italic"><line x1="19" x2="10" y1="4" y2="4"/><line x1="14" x2="5" y1="20" y2="20"/><line x1="15" x2="9" y1="4" y2="20"/></svg>
                                        </button>
                                        <button type="button" class="formatting-btn" title="Underline">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-underline-icon lucide-underline"><path d="M6 4v6a6 6 0 0 0 12 0V4"/><line x1="4" x2="20" y1="20" y2="20"/></svg>
                                        </button>
                                    </div>
                                    <button type="submit" class="submit-review">
                                        <i class="fas fa-paper-plane"></i>
                                        Submit Review
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                {% endif %}
            </div>

            <!-- Review Metrics Card -->
            {% if location.rating_count > 0 %}
            <div class="review-metrics-card">
                <div class="metrics-header">
                    <div class="overall-rating">
                        <h3 class="rating-number">{{ location.average_rating|floatformat:1 }}</h3>
                        <div class="rating-info">
                            <div class="rating-stars">
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= location.average_rating|floatformat:0|add:0 %}
                                        {% include 'stars_app/icons/star-filled-icon.svg' %}
                                    {% else %}
                                        {% include 'stars_app/icons/star-empty-icon.svg' %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <p class="total-reviews">{{ location.rating_count }} review{{ location.rating_count|pluralize }}</p>
                        </div>
                    </div>
                    
                    <div class="rating-breakdown">
                        {% for star_count in "54321"|make_list %}
                            <div class="rating-row">
                                <div class="rating-bar">
                                    <div class="rating-bar-fill" data-star="{{ star_count }}" style="width: 0%"></div>
                                </div>
                                <span class="star-label">{{ star_count }}.0</span>
                                <span class="rating-count" data-star-count="{{ star_count }}">0 reviews</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="reviews-list">
                {% if page_obj %}
                    {% for review in page_obj %}
                        <div class="review-card {% if review.user == user %}current-user-review{% endif %}">
                            <div class="review-header">
                                <div class="review-author-section">
                                    <img src="{{ review.user.userprofile.get_profile_picture_url }}"
                                         alt="{{ review.user.username }}'s profile picture"
                                         class="review-profile-picture">
                                    <div class="review-author">
                                        <span class="review-username">{{ review.user.username }}</span>
                                        {% if review.user == user %}
                                            <span class="your-review-badge">Your Review</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="review-rating-section">
                                    <div class="rating-display">
                                        {% for i in "12345"|make_list %}
                                            {% if forloop.counter <= review.rating %}
                                                {% include 'stars_app/icons/star-filled-icon.svg' %}
                                            {% else %}
                                                {% include 'stars_app/icons/star-empty-icon.svg' %}
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="review-meta">
                                        <span class="review-date">{{ review.created_at|date:"M d, Y" }}</span>
                                    </div>
                                </div>
                            </div>

                            {% if review.comment %}
                                <div class="review-comment" 
                                     data-editable="review" 
                                     data-location-id="{{ location.id }}"
                                     data-review-id="{{ review.id }}" 
                                     data-original-content="{{ review.comment }}"
                                     data-rating="{{ review.rating }}">
                                    {{ review.comment|markdown_format }}
                                </div>
                            {% endif %}

                            <!-- Add voting controls -->
                            <div class="vote-controls">
                                {% if user.is_authenticated %}
                                    {% if review.user != user %}
                                        <!-- Existing interactive voting buttons -->
                                        <button class="vote-button upvote {% if review.user_vote == 'up' %}voted{% endif %}"
                                                data-review-id="{{ review.id }}"
                                                data-location-id="{{ location.id }}"
                                                data-vote-type="up">
                                            {% include 'stars_app/icons/thumbs-up-icon.svg' %}
                                        </button>

                                        <span class="upvote-count">{{ review.cached_upvote_count }}</span>

                                        <button class="vote-button downvote {% if review.user_vote == 'down' %}voted{% endif %}"
                                                data-review-id="{{ review.id }}"
                                                data-location-id="{{ location.id }}"
                                                data-vote-type="down">
                                            {% include 'stars_app/icons/thumbs-down-icon.svg' %}
                                        </button>

                                        <span class="downvote-count">{{ review.cached_downvote_count }}</span>
                                        
                                        <!-- Comments toggle button inline with voting -->
                                        <button class="comments-toggle inline" data-review-id="{{ review.id }}">
                                            {% include 'stars_app/icons/comment-icon.svg' %}
                                            <span class="comments-count">{{ review.comments.count }} Comments</span>
                                        </button>
                                        
                                        <!-- Ellipsis menu button -->
                                        <div class="ellipsis-menu-wrapper">
                                            <button class="ellipsis-menu-button" data-review-id="{{ review.id }}">
                                                {% include 'stars_app/icons/ellipsis-icon.svg' %}
                                            </button>
                                            <div class="dropdown-menu" data-review-id="{{ review.id }}" style="display: none;">
                                                <button class="dropdown-item report-item" data-action="report" data-review-id="{{ review.id }}">
                                                    {% include 'stars_app/icons/flag-icon.svg' %}
                                                    <span>Report</span>
                                                </button>
                                            </div>
                                        </div>
                                    {% else %}
                                        <!-- New disabled buttons for own review -->
                                        <button class="vote-button disabled" disabled>
                                            {% include 'stars_app/icons/thumbs-up-icon.svg' %}
                                        </button>
                                        <span class="upvote-count">{{ review.cached_upvote_count }}</span>

                                        <button class="vote-button disabled" disabled>
                                            {% include 'stars_app/icons/thumbs-down-icon.svg' %}
                                        </button>
                                        <span class="downvote-count">{{ review.cached_downvote_count }}</span>

                                        <!-- Comments toggle button inline with voting -->
                                        <button class="comments-toggle inline" data-review-id="{{ review.id }}">
                                            {% include 'stars_app/icons/comment-icon.svg' %}
                                            <span class="comments-count">{{ review.comments.count }} Comments</span>
                                        </button>
                                        
                                        <!-- Ellipsis menu button -->
                                        <div class="ellipsis-menu-wrapper">
                                            <button class="ellipsis-menu-button" data-review-id="{{ review.id }}">
                                                {% include 'stars_app/icons/ellipsis-icon.svg' %}
                                            </button>
                                            {% if user == review.user %}
                                            <div class="dropdown-menu" data-review-id="{{ review.id }}" style="display: none;">
                                                <button class="dropdown-item delete-item" data-action="delete" data-review-id="{{ review.id }}">
                                                    {% include 'stars_app/icons/trash-icon.svg' %}
                                                    <span>Delete</span>
                                                </button>
                                                <button class="dropdown-item edit-item" data-action="edit" data-review-id="{{ review.id }}">
                                                    {% include 'stars_app/icons/pencil-icon.svg' %}
                                                    <span>Edit</span>
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <!-- Disabled buttons for logged out users -->
                                    <button class="vote-button disabled" disabled>
                                        {% include 'stars_app/icons/thumbs-up-icon.svg' %}
                                    </button>
                                    <span class="upvote-count">{{ review.cached_upvote_count }}</span>

                                    <button class="vote-button disabled" disabled>
                                        {% include 'stars_app/icons/thumbs-down-icon.svg' %}
                                    </button>
                                    <span class="downvote-count">{{ review.cached_downvote_count }}</span>
                                    
                                    <!-- Comments toggle button inline with voting -->
                                    <button class="comments-toggle inline" data-review-id="{{ review.id }}">
                                        {% include 'stars_app/icons/comment-icon.svg' %}
                                        <span class="comments-count">{{ review.comments.count }} Comments</span>
                                    </button>
                                    
                                    <!-- Ellipsis menu button -->
                                    <div class="ellipsis-menu-wrapper">
                                        <button class="ellipsis-menu-button" data-review-id="{{ review.id }}">
                                            {% include 'stars_app/icons/ellipsis-icon.svg' %}
                                        </button>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Add the collapsible comments section -->
                            <div class="review-comments-section">

                                <div class="comments-container" id="comments-{{ review.id }}" style="display: none;">
                                    <!-- Comment form for all users - disabled state for non-authenticated -->
                                    <form class="comment-form {% if not user.is_authenticated %}disabled{% endif %}"
                                          data-review-id="{{ review.id }}"
                                          data-location-id="{{ location.id }}">
                                        {% csrf_token %}
                                        <div class="comment-input" 
                                             {% if user.is_authenticated %}contenteditable="true"{% else %}contenteditable="false"{% endif %}
                                             data-placeholder="{% if user.is_authenticated %}Add a comment...{% else %}Login to comment...{% endif %}" 
                                             data-name="content"></div>
                                        <input type="hidden" name="content" class="hidden-content">
                                        <div class="comment-toolbar">
                                            <div class="comment-formatting-tools">
                                                <button type="button" class="formatting-btn" title="Bold" {% if not user.is_authenticated %}disabled{% endif %}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bold-icon lucide-bold"><path d="M6 12h9a4 4 0 0 1 0 8H7a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h7a4 4 0 0 1 0 8"/></svg>
                                                </button>
                                                <button type="button" class="formatting-btn" title="Italic" {% if not user.is_authenticated %}disabled{% endif %}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-italic-icon lucide-italic"><line x1="19" x2="10" y1="4" y2="4"/><line x1="14" x2="5" y1="20" y2="20"/><line x1="15" x2="9" y1="4" y2="20"/></svg>
                                                </button>
                                                <button type="button" class="formatting-btn" title="Underline" {% if not user.is_authenticated %}disabled{% endif %}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-underline-icon lucide-underline"><path d="M6 4v6a6 6 0 0 0 12 0V4"/><line x1="4" x2="20" y1="20" y2="20"/></svg>
                                                </button>
                                            </div>
                                            <button type="submit" class="submit-comment" {% if not user.is_authenticated %}disabled{% endif %}>
                                                {% if user.is_authenticated %}Post{% else %}Login to comment{% endif %}
                                            </button>
                                        </div>
                                    </form>

                                    <div class="comments-list" id="comments-list-{{ review.id }}">
                                        {% for comment in review.comments.all %}
                                            <div class="comment">
                                                <img src="{{ comment.user.userprofile.get_profile_picture_url }}"
                                                     alt="{{ comment.user.username }}'s profile picture"
                                                     class="comment-profile-picture">
                                                <div class="comment-content">
                                                    <div class="comment-header">
                                                        <span class="comment-username">{{ comment.user.username }}</span>
                                                        <span class="comment-date">{{ comment.created_at|date:"M d, Y" }}</span>
                                                        {% if user == comment.user %}
                                                            <button class="comment-edit-btn" 
                                                                    data-comment-id="{{ comment.id }}"
                                                                    data-review-id="{{ review.id }}"
                                                                    data-location-id="{{ location.id }}"
                                                                    title="Edit comment">
                                                                {% include 'stars_app/icons/pencil-icon.svg' %}
                                                            </button>
                                                        {% endif %}
                                                    </div>
                                                    <p class="comment-text" 
                                                       data-editable="comment" 
                                                       data-location-id="{{ location.id }}"
                                                       data-review-id="{{ review.id }}"
                                                       data-comment-id="{{ comment.id }}" 
                                                       data-original-content="{{ comment.content }}">
                                                        {{ comment.content|markdown_format }}
                                                    </p>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    <!-- Pagination controls -->
                    {% if page_obj.paginator.num_pages > 1 %}
                        <div class="pagination-container">
                            {% if page_obj.has_previous %}
                                <a href="?page={{ page_obj.previous_page_number }}"
                                   class="pagination-button">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </a>
                            {% endif %}

                            <span class="pagination-info">
                                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                            </span>

                            {% if page_obj.has_next %}
                                <a href="?page={{ page_obj.next_page_number }}"
                                   class="pagination-button">
                                    Next <i class="fas fa-chevron-right"></i>
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                    <div class="no-reviews">No reviews yet</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="report-modal" id="reportModal">
    <div class="report-modal-content">
        <div class="modal-header">
            <h3>Report Location</h3>
            <button class="modal-close" id="closeReportModal">&times;</button>
        </div>
        <form id="reportForm" class="report-form">
            <div class="form-group">
                <label for="reportType">Report Type</label>
                <select id="reportType" name="report_type" required>
                    <option value="">Select a reason...</option>
                    <option value="DUPLICATE">Duplicate location</option>
                    <option value="INACCURATE">Inaccurate information</option>
                    <option value="SPAM">Spam or inappropriate</option>
                    <option value="UNSAFE">Unsafe location</option>
                    <option value="CLOSED">Location no longer accessible</option>
                    <option value="OTHER">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="reportDescription">Description</label>
                <textarea id="reportDescription" name="description" rows="4" 
                          placeholder="Please provide more details about your report..." required></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-cancel" id="cancelReport">Cancel</button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-flag"></i> Submit Report
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Initialize carousel and photo functionality after DOM loads
document.addEventListener('DOMContentLoaded', function() {
    // Django template variables for JavaScript
    const locationId = '{{ location.id }}';
    const isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
    const isOwner = {% if is_owner %}true{% else %}false{% endif %};
    const currentUsername = '{{ user.username|default:"" }}';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const mapboxToken = '{{ mapbox_token }}';
    const locationLongitude = {{ location.longitude }};
    const locationLatitude = {{ location.latitude }};
    const locationName = '{{ location.name|escapejs }}';
    
    // Initialize Photo Gallery and Carousel
    loadPhotosAndInitialize();
    
    // Initialize star rating on existing form
    initializeStarRating();
    
    // Initialize review form toggle
    initializeReviewFormToggle();
    
    // Define the review form HTML with rich text editor (for use after deletion)
    const reviewFormHTML = `
        <h5>Write a Review</h5>
        <form method="POST" class="review-form">
            <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
            <div class="rating-input">
                <label>Rating:</label>
                <div class="star-rating">
                    <input type="radio" id="new-star1" name="rating" value="1" required>
                    <label for="new-star1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star">
                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                        </svg>
                    </label>
                    <input type="radio" id="new-star2" name="rating" value="2" required>
                    <label for="new-star2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star">
                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                        </svg>
                    </label>
                    <input type="radio" id="new-star3" name="rating" value="3" required>
                    <label for="new-star3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star">
                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                        </svg>
                    </label>
                    <input type="radio" id="new-star4" name="rating" value="4" required>
                    <label for="new-star4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star">
                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                        </svg>
                    </label>
                    <input type="radio" id="new-star5" name="rating" value="5" required>
                    <label for="new-star5">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star">
                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                        </svg>
                    </label>
                </div>
            </div>
            <div class="review-comment-input">
                <label for="comment">Comment:</label>
                <div class="comment-form">
                    <div class="comment-input" 
                         contenteditable="true"
                         data-placeholder="Share your experience at this location..." 
                         data-name="comment"></div>
                    <input type="hidden" name="comment" class="hidden-content">
                    <div class="comment-toolbar">
                        <div class="comment-formatting-tools">
                            <button type="button" class="formatting-btn" title="Bold">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bold-icon lucide-bold"><path d="M6 12h9a4 4 0 0 1 0 8H7a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h7a4 4 0 0 1 0 8"/></svg>
                            </button>
                            <button type="button" class="formatting-btn" title="Italic">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-italic-icon lucide-italic"><line x1="19" x2="10" y1="4" y2="4"/><line x1="14" x2="5" y1="20" y2="20"/><line x1="15" x2="9" y1="4" y2="20"/></svg>
                            </button>
                            <button type="button" class="formatting-btn" title="Underline">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-underline-icon lucide-underline"><path d="M6 4v6a6 6 0 0 0 12 0V4"/><line x1="4" x2="20" y1="20" y2="20"/></svg>
                            </button>
                        </div>
                        <button type="submit" class="submit-review">
                            <i class="fas fa-paper-plane"></i>
                            Submit Review
                        </button>
                    </div>
                </div>
            </div>
        </form>
    `;

    async function loadPhotosAndInitialize() {
        try {
            const response = await fetch(`/api/v1/viewing-locations/${locationId}/photos/`, {
                credentials: 'same-origin'
            });
            
            if (response.ok) {
                const data = await response.json();
                const photos = data.results || data;
                
                initializeHeroCarousel(photos);
                initializePhotosGrid(photos);
                
                if (isAuthenticated) {
                    initializeUploadModal();
                }
            }
        } catch (error) {
            console.error('Error loading photos:', error);
            initializeHeroCarousel([]);
            initializePhotosGrid([]);
        }
    }

    function initializeHeroCarousel(photos) {
        const carouselContent = document.getElementById('carouselContent');
        const photoCredit = document.getElementById('photoCredit');
        const prevBtn = document.getElementById('carouselPrev');
        const nextBtn = document.getElementById('carouselNext');
        
        if (!photos || photos.length === 0) {
            // Show default map view
            carouselContent.innerHTML = `
                <div class="carousel-slide active">
                    <img src="https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v11/static/${locationLongitude},${locationLatitude},13/1200x500@2x?access_token=${mapboxToken}"
                         alt="Map view of ${locationName}">
                </div>
            `;
            photoCredit.innerHTML = 'Map data © Mapbox';
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
            return;
        }

        let currentSlide = 0;
        
        // Create slides
        carouselContent.innerHTML = photos.map((photo, index) => `
            <div class="carousel-slide ${index === 0 ? 'active' : ''}">
                <img src="${photo.image_url}" alt="${photo.caption || 'Location photo'}">
            </div>
        `).join('');
        
        function updatePhotoCredit() {
            const currentPhoto = photos[currentSlide];
            if (currentPhoto) {
                photoCredit.innerHTML = `Photo by ${currentPhoto.uploaded_by_username || 'Unknown'} • ${formatDate(currentPhoto.uploaded_at || currentPhoto.created_at)}`;
            }
        }
        
        function showSlide(index) {
            const slides = carouselContent.querySelectorAll('.carousel-slide');
            slides.forEach((slide, i) => {
                slide.classList.toggle('active', i === index);
            });
            currentSlide = index;
            updatePhotoCredit();
        }
        
        prevBtn.addEventListener('click', () => {
            const newIndex = currentSlide > 0 ? currentSlide - 1 : photos.length - 1;
            showSlide(newIndex);
        });
        
        nextBtn.addEventListener('click', () => {
            const newIndex = currentSlide < photos.length - 1 ? currentSlide + 1 : 0;
            showSlide(newIndex);
        });
        
        updatePhotoCredit();
        
        // Auto-advance carousel
        setInterval(() => {
            const newIndex = currentSlide < photos.length - 1 ? currentSlide + 1 : 0;
            showSlide(newIndex);
        }, 5000);
    }
    
    function initializePhotosGrid(photos) {
        const photosGrid = document.getElementById('photosGrid');
        const photosTitle = document.getElementById('photosTitle');
        
        photosTitle.textContent = `Photos (${photos.length})`;
        
        if (!photos || photos.length === 0) {
            photosGrid.innerHTML = `
                <div class="no-photos" style="grid-column: 1 / -1; text-align: center; padding: var(--space-xl); color: var(--text-tertiary);">
                    <i class="fas fa-image" style="font-size: 3rem; margin-bottom: var(--space-md); opacity: 0.5;"></i>
                    <p>No photos yet</p>
                    ${isAuthenticated ? '<p class="text-muted">Be the first to add a photo!</p>' : ''}
                </div>
            `;
            return;
        }
        
        photosGrid.innerHTML = photos.map(photo => `
            <div class="photo-thumbnail ${photo.is_primary ? 'primary' : ''}" data-photo-id="${photo.id}" onclick="openPhotoLightbox('${photo.image_url}')">
                <img src="${photo.thumbnail_url || photo.image_url}" alt="${photo.caption || 'Location photo'}" loading="lazy">
            </div>
        `).join('');
    }
    
    function initializeUploadModal() {
        const uploadBtn = document.getElementById('openUploadModal');
        if (uploadBtn) {
            uploadBtn.addEventListener('click', () => {
                // Create and show upload modal
                const modal = createUploadModal();
                document.body.appendChild(modal);
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            });
        }
    }
    
    function createUploadModal() {
        const modal = document.createElement('div');
        modal.className = 'photo-upload-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Upload Photo</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <form class="photo-upload-form">
                    <div class="form-group">
                        <label for="photoFile">Select Photo</label>
                        <input type="file" id="photoFile" name="image" accept="image/*" required>
                        <div class="file-preview"></div>
                    </div>
                    <div class="form-group">
                        <label for="photoCaption">Caption (optional)</label>
                        <textarea id="photoCaption" name="caption" rows="3" placeholder="Describe this photo..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-cancel">Cancel</button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-upload"></i> Upload Photo
                        </button>
                    </div>
                </form>
            </div>
        `;
        
        // Add event listeners
        const closeBtn = modal.querySelector('.modal-close');
        const cancelBtn = modal.querySelector('.btn-cancel');
        const form = modal.querySelector('.photo-upload-form');
        const fileInput = modal.querySelector('#photoFile');
        
        function closeModal() {
            modal.remove();
            document.body.style.overflow = '';
        }
        
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            const preview = modal.querySelector('.file-preview');
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 100%; height: auto; border-radius: var(--radius-sm);">`;
                };
                reader.readAsDataURL(file);
            }
        });
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const submitBtn = form.querySelector('.btn-primary');
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            
            try {
                const response = await fetch(`/api/v1/viewing-locations/${locationId}/upload_photo/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData,
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    closeModal();
                    // Reload photos
                    loadPhotosAndInitialize();
                    showMessage('Photo uploaded successfully!', 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showMessage(error.message || 'Failed to upload photo', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Photo';
            }
        });
        
        return modal;
    }
    
    // Global functions
    window.openPhotoLightbox = function(imageSrc) {
        const lightbox = document.createElement('div');
        lightbox.className = 'photo-lightbox';
        lightbox.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000; display: flex;
            align-items: center; justify-content: center; padding: var(--space-lg);
        `;
        lightbox.innerHTML = `
            <div style="position: relative; max-width: 90%; max-height: 90vh;">
                <img src="${imageSrc}" style="max-width: 100%; max-height: 90vh; object-fit: contain;">
                <button style="position: absolute; top: -40px; right: 0; background: none; border: none; color: white; font-size: 2rem; cursor: pointer;">&times;</button>
            </div>
        `;
        
        document.body.appendChild(lightbox);
        document.body.style.overflow = 'hidden';
        
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox || e.target.tagName === 'BUTTON') {
                lightbox.remove();
                document.body.style.overflow = '';
            }
        });
    };
    
    function showMessage(message, type) {
        const messageEl = document.createElement('div');
        messageEl.className = `gallery-message ${type}`;
        messageEl.textContent = message;
        messageEl.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            padding: var(--space-sm) var(--space-md); border-radius: var(--radius-sm);
            color: white; font-size: var(--font-size-sm); max-width: 300px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            background: ${type === 'success' ? 'var(--success)' : 'var(--negate)'};
        `;
        
        document.body.appendChild(messageEl);
        
        setTimeout(() => {
            messageEl.remove();
        }, 3000);
    }
    
    function formatDate(dateString) {
        if (!dateString) return 'Unknown date';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (error) {
            return 'Invalid date';
        }
    }

    // Favorite functionality
    let isFavorited = false;

    function updateFavoriteButton() {
        const favoriteButton = document.querySelector('.favorite-button');
        const favoriteText = document.getElementById('favoriteText');

        if (favoriteButton && favoriteText) {
            favoriteButton.classList.toggle('favorited', isFavorited);
            favoriteText.textContent = isFavorited ? 'Remove from Favorites' : 'Add to Favorites';
        }
    }

    // Check initial favorite status when page loads
    if (isAuthenticated) {
        const favoriteButton = document.querySelector('.favorite-button');
        if (favoriteButton) {
            fetch(`/api/v1/viewing-locations/${locationId}/favorite/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                isFavorited = data.is_favorited;
                updateFavoriteButton();
            })
            .catch(error => console.error('Error checking favorite status:', error));

            // Add click handler for favorite button
            favoriteButton.addEventListener('click', function() {
                const endpoint = isFavorited ? 'unfavorite' : 'favorite';

                fetch(`/api/v1/viewing-locations/${locationId}/${endpoint}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    isFavorited = !isFavorited;
                    updateFavoriteButton();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
            });
        }
    }


    // Add delete review functionality
    const reviewsList = document.querySelector('.reviews-list');
    if (reviewsList) {
        reviewsList.addEventListener('click', function(e) {
            // Ellipsis menu button handling
            const ellipsisButton = e.target.closest('.ellipsis-menu-button');
            if (ellipsisButton) {
                e.preventDefault();
                e.stopPropagation();
                
                const reviewId = ellipsisButton.dataset.reviewId;
                const dropdown = document.querySelector(`.dropdown-menu[data-review-id="${reviewId}"]`);
                
                if (dropdown) {
                    // Close all other dropdowns first
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        if (menu !== dropdown) {
                            menu.style.display = 'none';
                        }
                    });
                    
                    // Toggle current dropdown
                    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                }
            }
            
            // Comment edit button handling
            const commentEditBtn = e.target.closest('.comment-edit-btn');
            if (commentEditBtn) {
                e.preventDefault();
                e.stopPropagation();
                
                const commentId = commentEditBtn.dataset.commentId;
                const reviewId = commentEditBtn.dataset.reviewId;
                const locationIdVal = commentEditBtn.dataset.locationId;
                
                // Find the comment text element to make editable
                const commentElement = document.querySelector(`[data-comment-id="${commentId}"][data-editable="comment"]`);
                
                if (commentElement) {
                    const originalContent = commentElement.getAttribute('data-original-content');
                    const ids = {
                        locationId: locationIdVal,
                        reviewId: reviewId,
                        commentId: commentId
                    };
                    
                    makeEditable(commentElement, 'comment', ids, originalContent);
                }
                
                return;
            }
            
            // Edit item in dropdown handling
            const editItem = e.target.closest('.edit-item');
            if (editItem) {
                e.preventDefault();
                e.stopPropagation();
                
                const reviewId = editItem.dataset.reviewId;
                // locationId is already available in scope
                
                // Find the review comment element to make editable
                const reviewElement = document.querySelector(`[data-review-id="${reviewId}"][data-editable="review"]`);
                
                if (reviewElement) {
                    const originalContent = reviewElement.getAttribute('data-original-content');
                    const ids = {
                        locationId: locationId,
                        reviewId: reviewId
                    };
                    
                    makeEditable(reviewElement, 'review', ids, originalContent);
                    
                    // Close the dropdown menu
                    const dropdown = editItem.closest('.dropdown-menu');
                    if (dropdown) {
                        dropdown.style.display = 'none';
                    }
                }
                
                return;
            }
            
            // Delete item in dropdown handling
            const deleteItem = e.target.closest('.delete-item');
            if (deleteItem) {
                e.preventDefault();
                e.stopPropagation();
                
                const reviewId = deleteItem.dataset.reviewId;
                
                if (confirm('Are you sure you want to delete your review?')) {
                    fetch(`/delete-review/${reviewId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to delete review');
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Close the dropdown menu
                            const dropdown = deleteItem.closest('.dropdown-menu');
                            if (dropdown) {
                                dropdown.style.display = 'none';
                            }
                            
                            // Remove the review card
                            deleteItem.closest('.review-card').remove();

                            // Check if there are any reviews left
                            if (!document.querySelector('.review-card')) {
                                reviewsList.innerHTML = '<div class="no-reviews">No reviews yet</div>';
                            }

                            // Update the toggle button state if it exists
                            const toggleBtn = document.getElementById('toggleReviewForm');
                            if (toggleBtn) {
                                // Remove disabled state and class
                                toggleBtn.disabled = false;
                                toggleBtn.classList.remove('disabled', 'active');
                                
                                // Update button text
                                const buttonSpan = toggleBtn.querySelector('span');
                                if (buttonSpan) {
                                    buttonSpan.textContent = 'Write a Review';
                                }
                                
                                // Update the icon from lock to pencil
                                const currentIcon = toggleBtn.querySelector('svg');
                                if (currentIcon) {
                                    // Create the square-pen icon SVG
                                    const newIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-pen">
                                        <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/>
                                    </svg>`;
                                    currentIcon.outerHTML = newIcon;
                                }
                            }

                            // Update the existing review form container
                            const existingFormContainer = document.getElementById('reviewFormContainer');
                            if (existingFormContainer && data.should_show_form) {
                                // Hide the container initially
                                existingFormContainer.style.display = 'none';
                                
                                // Update the container content with the review form
                                existingFormContainer.innerHTML = reviewFormHTML;

                                // Initialize star rating functionality
                                setTimeout(() => {
                                    initializeStarRating();
                                    
                                    // Initialize comment formatting for the rich text editor
                                    const form = existingFormContainer.querySelector('.comment-form');
                                    if (form) {
                                        const editableDiv = form.querySelector('.comment-input');
                                        const hiddenInput = form.querySelector('.hidden-content');
                                        
                                        // Set up the placeholder behavior
                                        if (editableDiv) {
                                            editableDiv.addEventListener('focus', function() {
                                                if (this.classList.contains('empty')) {
                                                    this.classList.remove('empty');
                                                    this.innerHTML = '';
                                                }
                                            });
                                            
                                            editableDiv.addEventListener('blur', function() {
                                                if (this.innerHTML.trim() === '') {
                                                    this.classList.add('empty');
                                                    this.innerHTML = '';
                                                }
                                            });
                                            
                                            editableDiv.addEventListener('input', function() {
                                                updateHiddenInput(this);
                                            });
                                            
                                            // Initialize as empty
                                            editableDiv.classList.add('empty');
                                        }
                                    }
                                }, 100);
                            }
                            
                            // Recalculate and update the metrics card
                            setTimeout(() => calculateRatingDistribution(), 100);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to delete review. Please try again.');
                    });
                }
            }

            // Vote button handling:
            const voteButton = e.target.closest('.vote-button');
            if (voteButton && !voteButton.classList.contains('disabled')) {
                e.preventDefault();

                const reviewId = voteButton.dataset.reviewId;
                const locationId = voteButton.dataset.locationId;
                const voteType = voteButton.dataset.voteType;
                const voteContainer = voteButton.closest('.vote-controls')

                fetch(`/api/v1/viewing-locations/${locationId}/reviews/${reviewId}/vote/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ vote_type: voteType }),
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    // Update vote counts
                    const upvoteCountElement = voteContainer.querySelector('.upvote-count');
                    const downvoteCountElement = voteContainer.querySelector('.downvote-count');
                    
                    if (upvoteCountElement) {
                        upvoteCountElement.textContent = data.upvotes;
                    }
                    if (downvoteCountElement) {
                        downvoteCountElement.textContent = data.downvotes;
                    }

                    // Update button states
                    const upvoteButton = voteContainer.querySelector('.upvote');
                    const downvoteButton = voteContainer.querySelector('.downvote');

                    // Update visual state
                    upvoteButton.classList.remove('voted');
                    downvoteButton.classList.remove('voted');

                    if (data.user_vote === 'up') {
                        upvoteButton.classList.add('voted');
                    } else if (data.user_vote === 'down') {
                        downvoteButton.classList.add('voted');
                    }

                    // Update data attributes
                    upvoteButton.dataset.currentVote = data.user_vote || '';
                    downvoteButton.dataset.currentVote = data.user_vote || '';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to register vote. Please try again.');
                });
            }
        });
    }

    function initializeStarRatingForContainer(container) {
        const labels = container.querySelectorAll('label');
        const inputs = container.querySelectorAll('input');
        
        // Handle hover effects
        labels.forEach((label, index) => {
            label.addEventListener('mouseover', function() {
                // Clear all hover states
                labels.forEach(l => l.classList.remove('hover'));
                // Add hover to current and all previous stars (left to right)
                for (let i = 0; i <= index; i++) {
                    labels[i].classList.add('hover');
                }
            });
            
            label.addEventListener('mouseout', function() {
                // Clear all hover states
                labels.forEach(l => l.classList.remove('hover'));
            });
            
            label.addEventListener('click', function() {
                const value = inputs[index].value;
                // Clear all filled states
                labels.forEach(l => l.classList.remove('filled'));
                // Fill stars from left to right up to selected value
                for (let i = 0; i < value; i++) {
                    labels[i].classList.add('filled');
                }
            });
        });
        
        // Handle input changes to maintain visual state
        inputs.forEach((input, index) => {
            input.addEventListener('change', function() {
                if (this.checked) {
                    const value = parseInt(this.value);
                    // Clear all filled states
                    labels.forEach(l => l.classList.remove('filled'));
                    // Fill stars from left to right up to selected value
                    for (let i = 0; i < value; i++) {
                        labels[i].classList.add('filled');
                    }
                }
            });
        });
    }

    function initializeStarRating() {
        const starContainers = document.querySelectorAll('.star-rating');
        
        starContainers.forEach(container => {
            initializeStarRatingForContainer(container);
        });
    }
    
    function initializeReviewFormToggle() {
        const toggleBtn = document.getElementById('toggleReviewForm');
        const formContainer = document.getElementById('reviewFormContainer');
        
        if (toggleBtn && formContainer) {
            toggleBtn.addEventListener('click', function() {
                // Don't allow interaction if button is disabled
                if (this.disabled || this.classList.contains('disabled')) {
                    return;
                }
                
                const isVisible = formContainer.style.display !== 'none';
                
                if (isVisible) {
                    formContainer.style.display = 'none';
                    toggleBtn.classList.remove('active');
                } else {
                    formContainer.style.display = 'block';
                    toggleBtn.classList.add('active');
                }
            });
        }
    }
    
    // Calculate and display rating distribution
    function calculateRatingDistribution() {
        const reviewCards = document.querySelectorAll('.review-card');
        const ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
        let totalReviews = 0;
        let totalRating = 0;
        
        // Count ratings from review cards
        reviewCards.forEach(card => {
            const filledStars = card.querySelectorAll('.rating-display svg.filled, .rating-display svg[style*="color: var(--golden)"]');
            const rating = filledStars.length;
            if (rating >= 1 && rating <= 5) {
                ratingCounts[rating]++;
                totalReviews++;
                totalRating += rating;
            }
        });
        
        // Get the metrics card
        const metricsCard = document.querySelector('.review-metrics-card');
        
        if (totalReviews === 0) {
            // Hide metrics card if no reviews
            if (metricsCard) {
                metricsCard.style.display = 'none';
            }
            return;
        }
        
        // Show metrics card if it was hidden
        if (metricsCard) {
            metricsCard.style.display = 'block';
        }
        
        // Calculate average rating
        const averageRating = totalRating / totalReviews;
        
        // Update overall rating number
        const ratingNumberElement = document.querySelector('.rating-number');
        if (ratingNumberElement) {
            ratingNumberElement.textContent = averageRating.toFixed(1);
        }
        
        // Update total reviews count
        const totalReviewsElement = document.querySelector('.total-reviews');
        if (totalReviewsElement) {
            const reviewText = totalReviews === 1 ? 'review' : 'reviews';
            totalReviewsElement.textContent = `${totalReviews} ${reviewText}`;
        }
        
        // Update star display with consistent styling
        const starContainer = document.querySelector('.rating-stars');
        if (starContainer) {
            const stars = starContainer.querySelectorAll('svg');
            const filledStars = Math.round(averageRating);
            
            stars.forEach((star, index) => {
                if (index < filledStars) {
                    star.style.color = 'var(--golden)';
                    star.style.fill = 'var(--golden)';
                } else {
                    star.style.color = 'var(--text-tertiary)';
                    star.style.fill = 'none'; // Consistent outline style for empty stars
                }
            });
        }
        
        // Update the rating bars and counts
        for (let star = 1; star <= 5; star++) {
            const count = ratingCounts[star];
            const percentage = totalReviews > 0 ? (count / totalReviews) * 100 : 0;
            
            const barFill = document.querySelector(`.rating-bar-fill[data-star="${star}"]`);
            const countElement = document.querySelector(`.rating-count[data-star-count="${star}"]`);
            
            if (barFill) {
                barFill.style.width = percentage + '%';
            }
            if (countElement) {
                const reviewText = count === 1 ? 'review' : 'reviews';
                countElement.textContent = `${count} ${reviewText}`;
            }
        }
    }
    
    // Call this after DOM is loaded
    setTimeout(calculateRatingDistribution, 100);


    // Handle comment section toggling
    document.querySelectorAll('.comments-toggle').forEach(button => {
        button.addEventListener('click', function() {
            const reviewId = this.dataset.reviewId;
            const commentsContainer = document.getElementById(`comments-${reviewId}`);
            const isHidden = commentsContainer.style.display === 'none';

            commentsContainer.style.display = isHidden ? 'block' : 'none';
        });
    });

    // Initialize formatting functionality for comment forms
    initializeCommentFormatting();

    // Handle comment submission
    document.querySelectorAll('.comment-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const reviewId = this.dataset.reviewId;
            const locationId = this.dataset.locationId;
            const commentInput = this.querySelector('.comment-input');
            const hiddenInput = this.querySelector('.hidden-content');
            
            // Get content from hidden input (markdown) or contenteditable div
            let content;
            if (hiddenInput && hiddenInput.value.trim()) {
                content = hiddenInput.value.trim();
            } else if (commentInput.contentEditable === 'true') {
                content = htmlToMarkdown(commentInput.innerHTML).trim();
            } else {
                content = commentInput.value.trim();
            }


            if (!content) return;

            fetch(`/api/v1/viewing-locations/${locationId}/reviews/${reviewId}/comments/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: content }),
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => {
                        throw new Error(error.detail || 'Failed to post comment');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Add the new comment to the list
                const commentsList = document.getElementById(`comments-list-${reviewId}`);
                const newComment = createCommentElement(data);
                commentsList.appendChild(newComment);

                // Clear the input
                if (commentInput.contentEditable === 'true') {
                    commentInput.innerHTML = '';
                    hiddenInput.value = '';
                    
                    // Clear all formatting button states
                    const form = commentInput.closest('.comment-form');
                    const buttons = form.querySelectorAll('.formatting-btn');
                    buttons.forEach(button => button.classList.remove('active'));
                } else {
                    commentInput.value = '';
                }

                // Update comment count in the voting controls
                const reviewCard = this.closest('.review-card');
                const countElement = reviewCard.querySelector('.comments-count');
                if (countElement) {
                    const currentCount = parseInt(countElement.textContent);
                    countElement.textContent = `${currentCount + 1} Comments`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to post comment. Please try again.');
            });
        });
    });

    function createCommentElement(comment) {
        const div = document.createElement('div');
        div.className = 'comment';

        // Handle both the old and new response formats
        const username = comment.user.username || comment.user;
        const profilePicUrl = comment.user.profile_picture_url || comment.user_profile_picture;
        
        // Check if this comment is from the current user
        const isCurrentUser = username === currentUsername;
        const editButton = isCurrentUser ? `
            <button class="comment-edit-btn" 
                    data-comment-id="${comment.id}"
                    data-review-id="${comment.review || comment.review_id}"
                    data-location-id="${comment.location || locationId}"
                    title="Edit comment">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/>
                    <path d="m15 5 4 4"/>
                </svg>
            </button>
        ` : '';

        div.innerHTML = `
            <img src="${profilePicUrl}"
                 alt="${username}'s profile picture"
                 class="comment-profile-picture">
            <div class="comment-content">
                <div class="comment-header">
                    <span class="comment-username">${username}</span>
                    <span class="comment-date">${formatDate(comment.created_at)}</span>
                    ${editButton}
                </div>
                <p class="comment-text" 
                   data-editable="comment" 
                   data-location-id="${comment.location || locationId}"
                   data-review-id="${comment.review || comment.review_id}"
                   data-comment-id="${comment.id}" 
                   data-original-content="${comment.content || comment.formatted_content}">
                    ${comment.formatted_content || comment.content}
                </p>
            </div>
        `;
        return div;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
    }

    // Report functionality
    const reportButton = document.getElementById('reportButton');
    const reportModal = document.getElementById('reportModal');
    const closeReportModal = document.getElementById('closeReportModal');
    const cancelReport = document.getElementById('cancelReport');
    const reportForm = document.getElementById('reportForm');

    if (reportButton) {
        reportButton.addEventListener('click', () => {
            reportModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        });
    }

    function closeReportModalFunc() {
        reportModal.style.display = 'none';
        document.body.style.overflow = '';
        reportForm.reset();
    }

    if (closeReportModal) {
        closeReportModal.addEventListener('click', closeReportModalFunc);
    }

    if (cancelReport) {
        cancelReport.addEventListener('click', closeReportModalFunc);
    }

    if (reportModal) {
        reportModal.addEventListener('click', (e) => {
            if (e.target === reportModal) {
                closeReportModalFunc();
            }
        });
    }

    if (reportForm) {
        reportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                report_type: document.getElementById('reportType').value,
                description: document.getElementById('reportDescription').value
            };

            try {
                const response = await fetch(`/api/v1/viewing-locations/${locationId}/report/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(formData),
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to submit report');
                }

                const result = await response.json();
                
                // Show success message
                alert('Thank you for your report. It will be reviewed by our moderators.');
                closeReportModalFunc();
                
            } catch (error) {
                console.error('Report error:', error);
                alert(error.message || 'Failed to submit report. Please try again.');
            }
        });
    }

    function initializeCommentFormatting() {
        // Add event listeners to all formatting buttons
        document.addEventListener('click', function(e) {
            if (e.target.closest('.formatting-btn')) {
                e.preventDefault();
                const button = e.target.closest('.formatting-btn');
                const form = button.closest('.comment-form');
                const editableDiv = form.querySelector('.comment-input');
                
                // Focus the editor first
                editableDiv.focus();
                
                // Get the formatting type from button title
                const formatType = button.getAttribute('title').toLowerCase();
                
                // Apply formatting using simple execCommand
                applyFormattingSimple(formatType);
                
                // Update button states and hidden input
                setTimeout(() => {
                    updateButtonStates(form);
                    updateHiddenInput(editableDiv);
                }, 10);
            }
        });

        // Update button states when selection changes
        document.addEventListener('selectionchange', function() {
            const activeElement = document.activeElement;
            if (activeElement && activeElement.classList.contains('comment-input') && activeElement.contentEditable === 'true') {
                const form = activeElement.closest('.comment-form');
                updateButtonStates(form);
            }
        });
        
        // Update hidden input when content changes
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('comment-input') && e.target.contentEditable === 'true') {
                updateHiddenInput(e.target);
            }
        });
    }

    function applyFormattingSimple(formatType) {
        // Use document.execCommand for reliable formatting
        let command;
        switch(formatType) {
            case 'bold':
                command = 'bold';
                break;
            case 'italic':
                command = 'italic';
                break;
            case 'underline':
                command = 'underline';
                break;
            default:
                return;
        }
        
        // Apply the formatting
        document.execCommand(command, false, null);
    }

    function updateHiddenInput(editableDiv) {
        const form = editableDiv.closest('.comment-form');
        const hiddenInput = form.querySelector('.hidden-content');
        
        // Convert HTML content to markdown for storage
        const htmlContent = editableDiv.innerHTML;
        const markdownContent = htmlToMarkdown(htmlContent);
        
        // Debug logging to see the conversion
        console.log('HTML:', htmlContent);
        console.log('Markdown:', markdownContent);
        
        hiddenInput.value = markdownContent;
    }

    function htmlToMarkdown(html) {
        // Create a temporary div to work with the HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // Process the HTML content to extract formatting
        const result = processNodeForMarkdown(tempDiv);
        
        return result.trim();
    }
    
    function processNodeForMarkdown(node) {
        if (node.nodeType === Node.TEXT_NODE) {
            return node.textContent;
        }
        
        if (node.nodeType === Node.ELEMENT_NODE) {
            let content = '';
            
            // Process all child nodes first
            for (let child of node.childNodes) {
                content += processNodeForMarkdown(child);
            }
            
            // Apply formatting based on the current element
            const tagName = node.tagName ? node.tagName.toLowerCase() : '';
            
            switch (tagName) {
                case 'strong':
                case 'b':
                    return `**${content}**`;
                case 'em':
                case 'i':
                    return `*${content}*`;
                case 'u':
                    return `__${content}__`;
                case 'br':
                    return '\n';
                case 'div':
                    return content + '\n';
                default:
                    return content;
            }
        }
        
        return '';
    }

    function updateButtonStates(form) {
        if (!form) return;
        
        const buttons = form.querySelectorAll('.formatting-btn');
        
        buttons.forEach(button => {
            const formatType = button.getAttribute('title').toLowerCase();
            let command;
            
            switch(formatType) {
                case 'bold':
                    command = 'bold';
                    break;
                case 'italic':
                    command = 'italic';
                    break;
                case 'underline':
                    command = 'underline';
                    break;
                default:
                    return;
            }
            
            // Use queryCommandState to check if formatting is active
            const isActive = document.queryCommandState(command);
            button.classList.toggle('active', isActive);
        });
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.ellipsis-menu-wrapper')) {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }
    });

    // Universal Editing System
    function makeEditable(element, type, ids, originalContent) {
        // Check if already in edit mode
        if (element.classList.contains('edit-mode')) {
            return; // Already editing, do nothing
        }
        
        // Hide the original content
        element.classList.add('edit-mode');
        
        // Create edit controls container
        const editControls = document.createElement('div');
        editControls.className = 'edit-controls';
        
        // Generate star rating section for reviews
        const starRatingSection = type === 'review' ? `
            <div class="rating-input">
                <label>Rating:</label>
                <div class="star-rating" data-current-rating="">
                    <input type="radio" id="edit-star1-${ids.reviewId}" name="rating" value="1" required>
                    <label for="edit-star1-${ids.reviewId}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star">
                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                        </svg>
                    </label>
                    <input type="radio" id="edit-star2-${ids.reviewId}" name="rating" value="2" required>
                    <label for="edit-star2-${ids.reviewId}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star">
                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                        </svg>
                    </label>
                    <input type="radio" id="edit-star3-${ids.reviewId}" name="rating" value="3" required>
                    <label for="edit-star3-${ids.reviewId}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star">
                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                        </svg>
                    </label>
                    <input type="radio" id="edit-star4-${ids.reviewId}" name="rating" value="4" required>
                    <label for="edit-star4-${ids.reviewId}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star">
                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                        </svg>
                    </label>
                    <input type="radio" id="edit-star5-${ids.reviewId}" name="rating" value="5" required>
                    <label for="edit-star5-${ids.reviewId}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star">
                            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
                        </svg>
                    </label>
                </div>
            </div>
        ` : '';
        
        editControls.innerHTML = `
            <div class="comment-form">
                ${starRatingSection}
                <div class="comment-input" 
                     contenteditable="true"
                     data-placeholder="Edit your ${type}..." 
                     data-name="content"></div>
                <input type="hidden" name="content" class="hidden-content">
                <div class="comment-toolbar">
                    <div class="comment-formatting-tools">
                        <button type="button" class="formatting-btn" title="Bold">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bold-icon lucide-bold"><path d="M6 12h9a4 4 0 0 1 0 8H7a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h7a4 4 0 0 1 0 8"/></svg>
                        </button>
                        <button type="button" class="formatting-btn" title="Italic">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-italic-icon lucide-italic"><line x1="19" x2="10" y1="4" y2="4"/><line x1="14" x2="5" y1="20" y2="20"/><line x1="15" x2="9" y1="4" y2="20"/></svg>
                        </button>
                        <button type="button" class="formatting-btn" title="Underline">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-underline-icon lucide-underline"><path d="M6 4v6a6 6 0 0 0 12 0V4"/><line x1="4" x2="20" y1="20" y2="20"/></svg>
                        </button>
                    </div>
                    <div class="edit-actions">
                        <button type="button" class="save-edit" data-type="${type}" data-ids='${JSON.stringify(ids)}'>
                            <i class="fas fa-check"></i>
                            Save
                        </button>
                        <button type="button" class="cancel-edit">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Insert edit controls after the original element
        element.parentNode.insertBefore(editControls, element.nextSibling);
        
        // Pre-populate the editor with original markdown content converted to HTML
        const commentInput = editControls.querySelector('.comment-input');
        const hiddenInput = editControls.querySelector('.hidden-content');
        
        // Convert markdown to HTML for editing
        const htmlContent = markdownToHtml(originalContent);
        commentInput.innerHTML = htmlContent;
        hiddenInput.value = originalContent;
        
        // Set current rating for reviews
        if (type === 'review') {
            // Get current rating from data attribute
            let currentRating = parseInt(element.getAttribute('data-rating')) || 3;
            
            // Set the radio button and visual state
            const ratingInput = editControls.querySelector(`input[name="rating"][value="${currentRating}"]`);
            if (ratingInput) {
                ratingInput.checked = true;
                
                // Set visual state for star rating
                const starContainer = editControls.querySelector('.star-rating');
                const labels = starContainer.querySelectorAll('label');
                for (let i = 0; i < currentRating; i++) {
                    labels[i].classList.add('filled');
                }
            }
            
            // Initialize star rating functionality for the edit form
            setTimeout(() => {
                const starContainer = editControls.querySelector('.star-rating');
                if (starContainer) {
                    initializeStarRatingForContainer(starContainer);
                }
            }, 100);
        }
        
        // Focus the editor
        commentInput.focus();
        
        // Set up event handlers
        const saveBtn = editControls.querySelector('.save-edit');
        const cancelBtn = editControls.querySelector('.cancel-edit');
        
        saveBtn.addEventListener('click', function() {
            const newContent = hiddenInput.value.trim();
            if (newContent) {
                // Get rating for reviews
                let rating = null;
                if (type === 'review') {
                    const ratingInput = editControls.querySelector('input[name="rating"]:checked');
                    if (ratingInput) {
                        rating = parseInt(ratingInput.value);
                    }
                }
                
                saveEdit(element, editControls, type, ids, newContent, rating);
            }
        });
        
        cancelBtn.addEventListener('click', function() {
            cancelEdit(element, editControls);
        });
    }
    
    function markdownToHtml(markdown) {
        if (!markdown) return '';
        
        // Enhanced markdown to HTML conversion with browser-compatible patterns
        let result = markdown;
        
        // Create unique placeholders for bold text to avoid conflicts
        const boldPlaceholders = [];
        result = result.replace(/\*\*(.*?)\*\*/g, function(match, content) {
            const placeholder = `__BOLD_${boldPlaceholders.length}__`;
            boldPlaceholders.push(content);
            return placeholder;
        });
        
        // Now handle italic (single asterisks)
        result = result.replace(/\*([^*\n]+?)\*/g, '<em>$1</em>');
        
        // Restore bold text
        boldPlaceholders.forEach((content, index) => {
            result = result.replace(`__BOLD_${index}__`, `<strong>${content}</strong>`);
        });
        
        // Handle underline
        result = result.replace(/__(.*?)__/g, '<u>$1</u>');
        
        // Handle line breaks
        result = result.replace(/\n/g, '<br>');
        
        // Clean up multiple spaces
        result = result.replace(/  +/g, ' ');
        
        return result;
    }
    
    function saveEdit(element, editControls, type, ids, newContent, rating = null) {
        // Determine API endpoint based on type
        let endpoint;
        if (type === 'review') {
            endpoint = `/api/v1/viewing-locations/${ids.locationId}/reviews/${ids.reviewId}/`;
        } else if (type === 'comment') {
            endpoint = `/api/v1/viewing-locations/${ids.locationId}/reviews/${ids.reviewId}/comments/${ids.commentId}/`;
        }
        
        // Prepare request body
        const requestBody = {
            [type === 'review' ? 'comment' : 'content']: newContent
        };
        
        // Add rating for reviews
        if (type === 'review' && rating !== null) {
            requestBody.rating = rating;
        }
        
        // Send update request
        fetch(endpoint, {
            method: 'PATCH',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody),
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(error => {
                    throw new Error(error.detail || 'Failed to update');
                });
            }
            return response.json();
        })
        .then(data => {
            // Update the original element with new formatted content
            const contentField = type === 'review' ? 'comment' : 'content';
            // Prefer formatted_content from backend, fallback to markdown conversion
            const formattedContent = data.formatted_content || markdownToHtml(data[contentField]);
            element.innerHTML = formattedContent;
            
            // Update data attribute
            element.setAttribute('data-original-content', data[contentField]);
            
            // Update star rating display for reviews
            if (type === 'review' && data.rating) {
                const reviewCard = element.closest('.review-card');
                const starElements = reviewCard.querySelectorAll('.rating-display svg');
                
                // Update star display with consistent styling
                starElements.forEach((star, index) => {
                    if (index < data.rating) {
                        star.style.color = 'var(--golden)';
                        star.style.fill = 'var(--golden)';
                        star.classList.add('filled');
                    } else {
                        star.style.color = 'var(--text-tertiary)';
                        star.style.fill = 'none'; // Ensure outline style for empty stars
                        star.classList.remove('filled');
                    }
                });
                
                // Recalculate and update metrics
                setTimeout(() => calculateRatingDistribution(), 100);
            }
            
            // Clean up edit mode
            cancelEdit(element, editControls);
        })
        .catch(error => {
            console.error('Error updating:', error);
            alert(`Failed to update ${type}. Please try again.`);
        });
    }
    
    function cancelEdit(element, editControls) {
        // Remove edit controls
        editControls.remove();
        
        // Show original content
        element.classList.remove('edit-mode');
    }

});
</script>
{% endblock %}