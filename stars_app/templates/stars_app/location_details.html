{% extends 'stars_app/base.html' %}
{% load static %}
{% load markdown_extras %}
{% load custom_filters %}
{% block body_class %}location-details-page{% endblock %}

<!-- Extra header content -->
{% block extra_head %}
<link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
<link href="{% static 'css/components/photo-gallery.css' %}" rel="stylesheet">
<link href="{% static 'css/pages/location_details/location_details.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="location-details-page">
    {% csrf_token %}

    <div class="location-details-container">
        <!-- Hero Section with Image Carousel -->
        <div class="hero-section">
            <div class="hero-carousel" id="heroCarousel">
                <div class="carousel-container">
                    <button class="carousel-nav prev" id="carouselPrev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="carousel-content" id="carouselContent">
                        <!-- Photos will be loaded here -->
                    </div>
                    <button class="carousel-nav next" id="carouselNext">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="hero-overlay">
                    <div class="hero-header">
                        <div class="hero-title-section">
                            <h1>{{ location.name }}</h1>
                            {% if location.is_verified %}
                                <span class="verification-badge" title="Verified on {{ location.verification_date|date:'M d, Y' }}">
                                    <i class="fas fa-check-circle"></i>
                                    Verified
                                </span>
                            {% endif %}
                            <div class="hero-rating">
                                <div class="rating-display">
                                    {% for i in "12345"|make_list %}
                                        {% if forloop.counter <= average_rating %}
                                            {% include 'stars_app/icons/star-filled-icon.svg' %}
                                        {% else %}
                                            {% include 'stars_app/icons/star-empty-icon.svg' %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <span class="rating-count">{{ total_reviews }} review{{ total_reviews|pluralize }}</span>
                            </div>
                        </div>
                        <div class="hero-actions">
                            {% if user.is_authenticated %}
                                <button class="hero-action-btn favorite-button" type="button" id="favoriteButton">
                                    <i class="fas fa-heart"></i>
                                    <span id="favoriteText">Favorite</span>
                                </button>
                                
                                {% if not is_owner %}
                                    <button class="hero-action-btn report-button" type="button" id="reportButton">
                                        <i class="fas fa-flag"></i>
                                        Report
                                    </button>
                                {% endif %}
                            {% endif %}
                            <a href="{% url 'map' %}?lat={{ location.latitude }}&lng={{ location.longitude }}&zoom=12"
                               class="hero-action-btn view-map-button">
                                <i class="fas fa-map"></i>
                                View on Map
                            </a>
                        </div>
                    </div>
                    <div class="photo-credit" id="photoCredit">
                        <!-- Photo credit will be shown here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Photo Gallery Section -->
        <div class="photos-section">
            <div class="photos-header">
                <h2 id="photosTitle">Photos (0)</h2>
                {% if user.is_authenticated %}
                    <button class="btn-upload-photo" id="openUploadModal">
                        <i class="fas fa-upload"></i>
                        Upload Photo
                    </button>
                {% endif %}
            </div>
            <div class="photos-grid" id="photosGrid">
                <!-- Photos will be loaded here -->
            </div>
        </div>

        <!-- About Section -->
        <div class="about-section">
            <h2>About this Location</h2>
            <p class="location-description">
                {% if location.description %}
                    {{ location.description }}
                {% else %}
                    This astronomical viewing location offers exceptional stargazing conditions. Perfect for observing deep sky objects, the Milky Way, and celestial events.
                {% endif %}
            </p>
        </div>

        <!-- Astronomy Data Section -->
        <div class="astronomy-data-section">
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="data-content">
                        <h3>Coordinates</h3>
                        <p>{{ location.latitude|floatformat:4 }}, {{ location.longitude|floatformat:4 }}</p>
                    </div>
                </div>
                <div class="data-item">
                    <div class="data-icon elevation">
                        <i class="fas fa-mountain"></i>
                    </div>
                    <div class="data-content">
                        <h3>Elevation</h3>
                        <p>{{ location.elevation|floatformat:0 }} meters</p>
                    </div>
                </div>
                <div class="data-item">
                    <div class="data-icon cloud">
                        <i class="fas fa-cloud"></i>
                    </div>
                    <div class="data-content">
                        <h3>Current Cloud Cover</h3>
                        <p>{{ location.cloudCoverPercentage|default:"Unknown"|floatformat:0 }}%</p>
                    </div>
                </div>
                <div class="data-item">
                    <div class="data-icon light">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="data-content">
                        <h3>Light Pollution</h3>
                        <p>{% if location.light_pollution_value < 18 %}Minimal{% elif location.light_pollution_value < 20 %}Low{% elif location.light_pollution_value < 21 %}Moderate{% else %}High{% endif %}</p>
                    </div>
                </div>
                <div class="data-item">
                    <div class="data-icon calendar">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="data-content">
                        <h3>Best Viewing Months</h3>
                        <p>{% if location.administrative_area == "Hawaii" %}Year-round optimal{% elif location.country == "United States" %}April - September{% else %}Check local conditions{% endif %}</p>
                    </div>
                </div>
                <div class="data-item">
                    <div class="data-icon access">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="data-content">
                        <h3>Access Information</h3>
                        <p>{% if location.verification_notes %}{{ location.verification_notes }}{% else %}Check local conditions and accessibility before visiting. {% if location.is_verified %}This location has been verified.{% endif %}{% endif %}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="reviews-section">
            <div class="reviews-header">
                <h2>Reviews</h2>
                <!-- Show toggle button for all users with appropriate state -->
                {% if not user.is_authenticated %}
                    <button class="toggle-review-form disabled" id="toggleReviewForm" disabled>
                        <span>Login to Review</span>
                        {% include 'stars_app/icons/lock-icon.svg' %}
                    </button>
                {% elif user.is_authenticated and user_has_reviewed %}
                    <button class="toggle-review-form disabled" id="toggleReviewForm" disabled>
                        <span>Already Reviewed</span>
                        {% include 'stars_app/icons/lock-icon.svg' %}
                    </button>
                {% elif is_owner %}
                    <button class="toggle-review-form disabled" id="toggleReviewForm" disabled>
                        <span>You own this location</span>
                        {% include 'stars_app/icons/lock-icon.svg' %}
                    </button>
                {% else %}
                    <button class="toggle-review-form" id="toggleReviewForm">
                        <span>Write a Review</span>
                        {% include 'stars_app/icons/square-pen-icon.svg' %}
                    </button>
                {% endif %}
            </div>

            <!-- Review form container - will be populated dynamically -->
            <div class="review-form-container" id="reviewFormContainer" style="display: none;">
                <!-- Form will be inserted here by JavaScript -->
            </div>

            <!-- Hidden Review Form Template (for cloning after deletion) -->
            <div id="reviewFormTemplate" style="display: none;">
                <h5>Write a Review</h5>
                <form method="POST" class="review-form">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    <div class="rating-input">
                        <label>Rating:</label>
                        <div class="star-rating">
                            <input type="radio" id="template-star1" name="rating" value="1" required>
                            <label for="template-star1">
                                {% include 'stars_app/icons/star-filled-icon.svg' %}
                            </label>
                            <input type="radio" id="template-star2" name="rating" value="2" required>
                            <label for="template-star2">
                                {% include 'stars_app/icons/star-filled-icon.svg' %}
                            </label>
                            <input type="radio" id="template-star3" name="rating" value="3" required>
                            <label for="template-star3">
                                {% include 'stars_app/icons/star-filled-icon.svg' %}
                            </label>
                            <input type="radio" id="template-star4" name="rating" value="4" required>
                            <label for="template-star4">
                                {% include 'stars_app/icons/star-filled-icon.svg' %}
                            </label>
                            <input type="radio" id="template-star5" name="rating" value="5" required>
                            <label for="template-star5">
                                {% include 'stars_app/icons/star-filled-icon.svg' %}
                            </label>
                        </div>
                    </div>
                    <div class="review-comment-input">
                        <label for="comment">Comment:</label>
                        <div class="comment-form">
                            <div class="comment-input" 
                                 contenteditable="true"
                                 data-placeholder="Share your experience at this location..." 
                                 data-name="comment"></div>
                            <input type="hidden" name="comment" class="hidden-content">
                            <div class="comment-toolbar">
                                <div class="comment-formatting-tools">
                                    <button type="button" class="formatting-btn" title="Bold">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bold-icon lucide-bold"><path d="M6 12h9a4 4 0 0 1 0 8H7a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h7a4 4 0 0 1 0 8"/></svg>
                                    </button>
                                    <button type="button" class="formatting-btn" title="Italic">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-italic-icon lucide-italic"><line x1="19" x2="10" y1="4" y2="4"/><line x1="14" x2="5" y1="20" y2="20"/><line x1="15" x2="9" y1="4" y2="20"/></svg>
                                    </button>
                                    <button type="button" class="formatting-btn" title="Underline">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-underline-icon lucide-underline"><path d="M6 4v6a6 6 0 0 0 12 0V4"/><line x1="4" x2="20" y1="20" y2="20"/></svg>
                                    </button>
                                </div>
                                <button type="submit" class="submit-review">
                                    <i class="fas fa-paper-plane"></i>
                                    Submit
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Review Metrics Card -->
            {% if location.rating_count > 0 %}
            <div class="review-metrics-card">
                <div class="metrics-header">
                    <div class="overall-rating">
                        <h3 class="rating-number">{{ location.average_rating|floatformat:1 }}</h3>
                        <div class="rating-info">
                            <div class="rating-stars">
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= location.average_rating|floatformat:0|add:0 %}
                                        {% include 'stars_app/icons/star-filled-icon.svg' %}
                                    {% else %}
                                        {% include 'stars_app/icons/star-empty-icon.svg' %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <p class="total-reviews">{{ location.rating_count }} review{{ location.rating_count|pluralize }}</p>
                        </div>
                    </div>
                    
                    <div class="rating-breakdown">
                        {% for star_count in "54321"|make_list %}
                            <div class="rating-row">
                                <div class="rating-bar">
                                    <div class="rating-bar-fill" data-star="{{ star_count }}" style="width: 0%"></div>
                                </div>
                                <span class="star-label">{{ star_count }}.0</span>
                                <span class="rating-count" data-star-count="{{ star_count }}">0 reviews</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="reviews-list">
                {% if page_obj %}
                    {% for review in page_obj %}
                        <div class="review-card {% if review.user == user %}current-user-review{% endif %}">
                            <div class="review-header">
                                <div class="review-author-section">
                                    <img src="{{ review.user.userprofile.get_profile_picture_url }}"
                                         alt="{{ review.user.username }}'s profile picture"
                                         class="review-profile-picture">
                                    <div class="review-author">
                                        <span class="review-username">{{ review.user.username }}</span>
                                        {% if review.user == user %}
                                            <span class="your-review-badge">Your Review</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="review-rating-section">
                                    <div class="rating-display">
                                        {% for i in "12345"|make_list %}
                                            {% if forloop.counter <= review.rating %}
                                                {% include 'stars_app/icons/star-filled-icon.svg' %}
                                            {% else %}
                                                {% include 'stars_app/icons/star-empty-icon.svg' %}
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="review-meta">
                                        <span class="review-date">{{ review.created_at|date:"M d, Y" }}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="review-comment" 
                                 data-editable="review" 
                                 data-location-id="{{ location.id }}"
                                 data-review-id="{{ review.id }}" 
                                 data-original-content="{{ review.comment|default:'' }}"
                                 data-rating="{{ review.rating }}">
                                {% if review.comment %}
                                    {{ review.comment|markdown_format }}
                                {% endif %}
                            </div>

                            <!-- Add voting controls -->
                            <div class="vote-controls">
                                {% if user.is_authenticated %}
                                    {% if review.user != user %}
                                        <!-- Existing interactive voting buttons -->
                                        <button class="vote-button upvote {% if review.user_vote == 'up' %}voted{% endif %}"
                                                data-review-id="{{ review.id }}"
                                                data-location-id="{{ location.id }}"
                                                data-vote-type="up">
                                            {% include 'stars_app/icons/thumbs-up-icon.svg' %}
                                        </button>

                                        <span class="upvote-count">{{ review.cached_upvote_count }}</span>

                                        <button class="vote-button downvote {% if review.user_vote == 'down' %}voted{% endif %}"
                                                data-review-id="{{ review.id }}"
                                                data-location-id="{{ location.id }}"
                                                data-vote-type="down">
                                            {% include 'stars_app/icons/thumbs-down-icon.svg' %}
                                        </button>

                                        <span class="downvote-count">{{ review.cached_downvote_count }}</span>
                                        
                                        <!-- Comments toggle button inline with voting -->
                                        <button class="comments-toggle inline" data-review-id="{{ review.id }}">
                                            {% include 'stars_app/icons/comment-icon.svg' %}
                                            <span class="comments-count">{{ review.comments.count }} Comments</span>
                                        </button>
                                        
                                        <!-- Ellipsis menu button -->
                                        <div class="ellipsis-menu-wrapper">
                                            <button class="ellipsis-menu-button" data-review-id="{{ review.id }}">
                                                {% include 'stars_app/icons/ellipsis-icon.svg' %}
                                            </button>
                                            <div class="dropdown-menu" data-review-id="{{ review.id }}" style="display: none;">
                                                <button class="dropdown-item report-item" data-action="report" data-review-id="{{ review.id }}">
                                                    {% include 'stars_app/icons/flag-icon.svg' %}
                                                    <span>Report</span>
                                                </button>
                                            </div>
                                        </div>
                                    {% else %}
                                        <!-- New disabled buttons for own review -->
                                        <button class="vote-button disabled" disabled>
                                            {% include 'stars_app/icons/thumbs-up-icon.svg' %}
                                        </button>
                                        <span class="upvote-count">{{ review.cached_upvote_count }}</span>

                                        <button class="vote-button disabled" disabled>
                                            {% include 'stars_app/icons/thumbs-down-icon.svg' %}
                                        </button>
                                        <span class="downvote-count">{{ review.cached_downvote_count }}</span>

                                        <!-- Comments toggle button inline with voting -->
                                        <button class="comments-toggle inline" data-review-id="{{ review.id }}">
                                            {% include 'stars_app/icons/comment-icon.svg' %}
                                            <span class="comments-count">{{ review.comments.count }} Comments</span>
                                        </button>
                                        
                                        <!-- Ellipsis menu button -->
                                        <div class="ellipsis-menu-wrapper">
                                            <button class="ellipsis-menu-button" data-review-id="{{ review.id }}">
                                                {% include 'stars_app/icons/ellipsis-icon.svg' %}
                                            </button>
                                            {% if user == review.user %}
                                            <div class="dropdown-menu" data-review-id="{{ review.id }}" style="display: none;">
                                                <button class="dropdown-item delete-item" data-action="delete" data-review-id="{{ review.id }}">
                                                    {% include 'stars_app/icons/trash-icon.svg' %}
                                                    <span>Delete</span>
                                                </button>
                                                <button class="dropdown-item edit-item" data-action="edit" data-review-id="{{ review.id }}">
                                                    {% include 'stars_app/icons/pencil-icon.svg' %}
                                                    <span>Edit</span>
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <!-- Disabled buttons for logged out users -->
                                    <button class="vote-button disabled" disabled>
                                        {% include 'stars_app/icons/thumbs-up-icon.svg' %}
                                    </button>
                                    <span class="upvote-count">{{ review.cached_upvote_count }}</span>

                                    <button class="vote-button disabled" disabled>
                                        {% include 'stars_app/icons/thumbs-down-icon.svg' %}
                                    </button>
                                    <span class="downvote-count">{{ review.cached_downvote_count }}</span>
                                    
                                    <!-- Comments toggle button inline with voting -->
                                    <button class="comments-toggle inline" data-review-id="{{ review.id }}">
                                        {% include 'stars_app/icons/comment-icon.svg' %}
                                        <span class="comments-count">{{ review.comments.count }} Comments</span>
                                    </button>
                                    
                                    <!-- Ellipsis menu button -->
                                    <div class="ellipsis-menu-wrapper">
                                        <button class="ellipsis-menu-button" data-review-id="{{ review.id }}">
                                            {% include 'stars_app/icons/ellipsis-icon.svg' %}
                                        </button>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Add the collapsible comments section -->
                            <div class="review-comments-section">

                                <div class="comments-container" id="comments-{{ review.id }}" style="display: none;">
                                    <!-- Comment form for all users - disabled state for non-authenticated -->
                                    <form class="comment-form {% if not user.is_authenticated %}disabled{% endif %}"
                                          data-review-id="{{ review.id }}"
                                          data-location-id="{{ location.id }}">
                                        {% csrf_token %}
                                        <div class="comment-input" 
                                             {% if user.is_authenticated %}contenteditable="true"{% else %}contenteditable="false"{% endif %}
                                             data-placeholder="{% if user.is_authenticated %}Add a comment...{% else %}Login to comment...{% endif %}" 
                                             data-name="content"></div>
                                        <input type="hidden" name="content" class="hidden-content">
                                        <div class="comment-toolbar">
                                            <div class="comment-formatting-tools">
                                                <button type="button" class="formatting-btn" title="Bold" {% if not user.is_authenticated %}disabled{% endif %}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bold-icon lucide-bold"><path d="M6 12h9a4 4 0 0 1 0 8H7a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h7a4 4 0 0 1 0 8"/></svg>
                                                </button>
                                                <button type="button" class="formatting-btn" title="Italic" {% if not user.is_authenticated %}disabled{% endif %}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-italic-icon lucide-italic"><line x1="19" x2="10" y1="4" y2="4"/><line x1="14" x2="5" y1="20" y2="20"/><line x1="15" x2="9" y1="4" y2="20"/></svg>
                                                </button>
                                                <button type="button" class="formatting-btn" title="Underline" {% if not user.is_authenticated %}disabled{% endif %}>
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-underline-icon lucide-underline"><path d="M6 4v6a6 6 0 0 0 12 0V4"/><line x1="4" x2="20" y1="20" y2="20"/></svg>
                                                </button>
                                            </div>
                                            <button type="submit" class="submit-comment" {% if not user.is_authenticated %}disabled{% endif %}>
                                                {% if user.is_authenticated %}Post{% else %}Login to comment{% endif %}
                                            </button>
                                        </div>
                                    </form>

                                    <div class="comments-list" id="comments-list-{{ review.id }}">
                                        {% for comment in review.comments.all %}
                                            <div class="comment">
                                                <img src="{{ comment.user.userprofile.get_profile_picture_url }}"
                                                     alt="{{ comment.user.username }}'s profile picture"
                                                     class="comment-profile-picture">
                                                <div class="comment-content">
                                                    <div class="comment-header">
                                                        <span class="comment-username">{{ comment.user.username }}</span>
                                                        <span class="comment-date">{{ comment.created_at|date:"M d, Y" }}</span>
                                                        {% if user == comment.user %}
                                                            <button class="comment-edit-btn" 
                                                                    data-comment-id="{{ comment.id }}"
                                                                    data-review-id="{{ review.id }}"
                                                                    data-location-id="{{ location.id }}"
                                                                    title="Edit comment">
                                                                {% include 'stars_app/icons/pencil-icon.svg' %}
                                                            </button>
                                                        {% endif %}
                                                    </div>
                                                    <p class="comment-text" 
                                                       data-editable="comment" 
                                                       data-location-id="{{ location.id }}"
                                                       data-review-id="{{ review.id }}"
                                                       data-comment-id="{{ comment.id }}" 
                                                       data-original-content="{{ comment.content }}">
                                                        {{ comment.content|markdown_format }}
                                                    </p>
                                                    
                                                    <!-- Comment voting controls -->
                                                    <div class="comment-vote-controls">
                                                        {% if user.is_authenticated %}
                                                            {% if comment.user != user %}
                                                                <!-- Interactive voting buttons for authenticated users (not comment owner) -->
                                                                <button class="vote-button upvote {% if comment_votes|get_item:comment.id == 1 %}voted{% endif %}"
                                                                        data-comment-id="{{ comment.id }}"
                                                                        data-review-id="{{ review.id }}"
                                                                        data-location-id="{{ location.id }}"
                                                                        data-vote-type="up">
                                                                    {% include 'stars_app/icons/thumbs-up-icon.svg' %}
                                                                </button>
                                                                <span class="upvote-count">{{ comment.upvote_count }}</span>
                                                                
                                                                <button class="vote-button downvote {% if comment_votes|get_item:comment.id == -1 %}voted{% endif %}"
                                                                        data-comment-id="{{ comment.id }}"
                                                                        data-review-id="{{ review.id }}"
                                                                        data-location-id="{{ location.id }}"
                                                                        data-vote-type="down">
                                                                    {% include 'stars_app/icons/thumbs-down-icon.svg' %}
                                                                </button>
                                                                <span class="downvote-count">{{ comment.downvote_count }}</span>
                                                            {% else %}
                                                                <!-- Disabled buttons for comment owner -->
                                                                <button class="vote-button disabled" disabled>
                                                                    {% include 'stars_app/icons/thumbs-up-icon.svg' %}
                                                                </button>
                                                                <span class="upvote-count">{{ comment.upvote_count }}</span>
                                                                
                                                                <button class="vote-button disabled" disabled>
                                                                    {% include 'stars_app/icons/thumbs-down-icon.svg' %}
                                                                </button>
                                                                <span class="downvote-count">{{ comment.downvote_count }}</span>
                                                            {% endif %}
                                                        {% else %}
                                                            <!-- Disabled buttons for non-authenticated users -->
                                                            <button class="vote-button disabled" disabled>
                                                                {% include 'stars_app/icons/thumbs-up-icon.svg' %}
                                                            </button>
                                                            <span class="upvote-count">{{ comment.upvote_count }}</span>
                                                            
                                                            <button class="vote-button disabled" disabled>
                                                                {% include 'stars_app/icons/thumbs-down-icon.svg' %}
                                                            </button>
                                                            <span class="downvote-count">{{ comment.downvote_count }}</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    <!-- Pagination controls -->
                    {% if page_obj.paginator.num_pages > 1 %}
                        <div class="pagination-container">
                            {% if page_obj.has_previous %}
                                <a href="?page={{ page_obj.previous_page_number }}"
                                   class="pagination-button">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </a>
                            {% endif %}

                            <span class="pagination-info">
                                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                            </span>

                            {% if page_obj.has_next %}
                                <a href="?page={{ page_obj.next_page_number }}"
                                   class="pagination-button">
                                    Next <i class="fas fa-chevron-right"></i>
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                    <div class="no-reviews">No reviews yet</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="report-modal" id="reportModal">
    <div class="report-modal-content">
        <div class="modal-header">
            <h3>Report Location</h3>
            <button class="modal-close" id="closeReportModal">&times;</button>
        </div>
        <form id="reportForm" class="report-form">
            <div class="form-group">
                <label for="reportType">Report Type</label>
                <select id="reportType" name="report_type" required>
                    <option value="">Select a reason...</option>
                    <option value="DUPLICATE">Duplicate location</option>
                    <option value="INACCURATE">Inaccurate information</option>
                    <option value="SPAM">Spam or inappropriate</option>
                    <option value="UNSAFE">Unsafe location</option>
                    <option value="CLOSED">Location no longer accessible</option>
                    <option value="OTHER">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="reportDescription">Description</label>
                <textarea id="reportDescription" name="description" rows="4" 
                          placeholder="Please provide more details about your report..." required></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-cancel" id="cancelReport">Cancel</button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-flag"></i> Submit Report
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Pass Django template variables to JavaScript
    window.locationDetailsConfig = {
        locationId: '{{ location.id }}',
        isAuthenticated: {% if user.is_authenticated %}true{% else %}false{% endif %},
        isOwner: {% if is_owner %}true{% else %}false{% endif %},
        currentUsername: '{{ user.username|default:"" }}',
        mapboxToken: '{{ mapbox_token }}',
        locationLongitude: {{ location.longitude }},
        locationLatitude: {{ location.latitude }},
        locationName: '{{ location.name|escapejs }}',
        userHasReviewed: {% if user_has_reviewed %}true{% else %}false{% endif %}
    };
</script>
<script src="{% static 'js/pages/location_details/location_details.js' %}"></script>
{% endblock %}